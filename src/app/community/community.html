<app-side-bar #sidebarRef (collapsedChange)="onSidebarToggle($event)"></app-side-bar>
<app-ai-chat></app-ai-chat>

<!-- ===== TOP NAV ===== -->
<nav class="top-nav" [class.sidebar-collapsed]="isSidebarCollapsed">
  <div class="nav-content">
    <div class="nav-left">
      <div>
        <div class="nav-page-title">المجتمع</div>
        <div class="nav-page-sub">شارك أفكارك وتواصل مع رواد الأعمال الآخرين</div>
      </div>
    </div>
    <div class="nav-right">
      <!-- Search — يظهر فقط على ديسكتوب -->
      <div class="search-wrap desktop-only-flex">
        <i class="bi bi-search search-icon"></i>
        <input type="text" [(ngModel)]="searchQuery" (input)="searchPosts()"
          placeholder="ابحث في المنشورات..." class="search-input">
      </div>
      <!-- زر منشور جديد -->
      <button class="btn-add" (click)="openNewPostModal()">
        <i class="bi bi-plus-lg"></i>
        <span class="btn-text">منشور جديد</span>
      </button>
      <!-- زر دليل الاستخدام -->
      <button class="guide-btn" (click)="openGuide()">
        <i class="bi bi-info-circle"></i>
        <span class="btn-text">دليل الاستخدام</span>
      </button>
      <!-- زر الهامبرجر — يظهر فقط على موبايل/تابلت -->
      <button class="topnav-hamburger" (click)="openSidebar()" aria-label="فتح القائمة">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>
</nav>

<!-- ===== GUIDE MODAL ===== -->
<div class="modal-overlay" *ngIf="showGuide" (click)="closeGuide()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-chat-dots"></i> دليل استخدام المجتمع</h3>
      <button class="close-btn" (click)="closeGuide()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">انضم لمجتمع رواد الأعمال وشارك خبراتك واستفد من تجارب الآخرين.</p>
      <div class="guide-features">
        <div class="guide-item">
          <i class="bi bi-pencil-square guide-icon"></i>
          <div><h4>النشر والمشاركة</h4><p>شارك أفكارك وتجاربك مع المجتمع</p></div>
        </div>
        <div class="guide-item">
          <i class="bi bi-heart guide-icon"></i>
          <div><h4>التفاعل</h4><p>أعجب بالمنشورات وعلق على ما يهمك</p></div>
        </div>
        <div class="guide-item">
          <i class="bi bi-tags guide-icon"></i>
          <div><h4>الوسوم</h4><p>استخدم الوسوم للوصول للمحتوى المناسب</p></div>
        </div>
        <div class="guide-item">
          <i class="bi bi-search guide-icon"></i>
          <div><h4>البحث</h4><p>ابحث عن منشورات بكلمات مفتاحية أو وسوم</p></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeGuide()">فهمت، شكراً</button>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<main class="community-main" [class.sidebar-collapsed]="isSidebarCollapsed">

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>جاري تحميل المجتمع...</p>
    </div>
  </div>

  <!-- رسائل النجاح والخطأ -->
  <div class="success-banner" *ngIf="successMessage">
    <i class="bi bi-check-circle-fill"></i>
    {{ successMessage }}
  </div>
  <div class="error-banner" *ngIf="errorMessage">
    <i class="bi bi-exclamation-triangle-fill"></i>
    {{ errorMessage }}
  </div>

  <!-- ===== WELCOME
       يعرض summaryCards[0].value (إجمالي المنشورات) و summaryCards[1].value (الأعضاء النشطون)
       تُحدَّث هذه القيم من API عبر loadCommunityStats() في ngOnInit
  ===== -->
  <section class="welcome-section">
    <div class="welcome-content">
      <div class="welcome-text">
        <h1 class="welcome-title">مجتمع خطوة <i class="bi bi-chat-fill"></i></h1>
        <p class="welcome-sub">تواصل مع رواد الأعمال وشارك الخبرات والأفكار</p>
      </div>
      <div class="welcome-badges">
        <!-- القيمة مشتركة مع بطاقة summaryCards[0] في قسم METRICS أدناه -->
        <div class="w-badge">
          <i class="bi bi-file-text w-badge-icon"></i>
          <div>
            <span class="w-badge-lbl">إجمالي المنشورات</span>
            <span class="w-badge-val">{{ summaryCards[0]?.value || 0 }}</span>
          </div>
        </div>
        <!-- القيمة مشتركة مع بطاقة summaryCards[1] في قسم METRICS أدناه -->
        <div class="w-badge">
          <i class="bi bi-people w-badge-icon"></i>
          <div>
            <span class="w-badge-lbl">أعضاء نشطون</span>
            <span class="w-badge-val">{{ summaryCards[1]?.value || 0 }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== METRICS
       كل بطاقة تأخذ بياناتها من summaryCards[] المُحمَّلة عبر loadCommunityStats()
       الكارد الأخير (منشورات اليوم) يعتمد على posts.length بعد تطبيق الفلتر
  ===== -->
  <section class="metrics-grid">
    <div class="mc" *ngFor="let card of summaryCards">
      <div class="mc-icon"><i class="bi bi-{{ card.biIcon }}"></i></div>
      <div class="mc-lbl">{{ card.title }}</div>
      <div class="mc-val" *ngIf="!card.loading">{{ card.value }}</div>
      <div class="mc-skeleton" *ngIf="card.loading"></div>
      <div class="mini-prog"><div class="mini-prog-fill g" style="width:65%"></div></div>
    </div>
    <!-- منشورات اليوم — يعتمد على posts.length المشتقة من applyFilters() -->
    <div class="mc">
      <div class="mc-icon"><i class="bi bi-fire"></i></div>
      <div class="mc-lbl">منشورات اليوم</div>
      <div class="mc-val">{{ posts.length }}</div>
      <div class="mini-prog"><div class="mini-prog-fill o" style="width:80%"></div></div>
    </div>
  </section>

  <!-- ===== CONTENT LAYOUT ===== -->
  <div class="content-layout">

    <!-- ===== POSTS COLUMN ===== -->
    <div class="posts-col">

      <!-- Filters — يُغيّر selectedFilter ويعيد تصفية posts عبر applyFilters() -->
      <div class="filters-bar">
        <div class="filter-tabs">
          <button *ngFor="let f of availableFilters"
            (click)="changeFilter(f.value)"
            [class.active]="selectedFilter === f.value"
            class="ftab">
            <i class="bi bi-{{ f.biIcon }}"></i> {{ f.label }}
          </button>
        </div>
      </div>

      <!-- قائمة المنشورات — تأتي من allPosts بعد الفلترة عبر applyFilters() -->
      <div class="posts-list" *ngIf="posts.length > 0; else noPosts">
        <div class="post-card" *ngFor="let post of posts">

          <!-- رأس المنشور -->
          <div class="post-head">
            <div class="author-wrap">
              <div class="author-avatar">{{ post.author?.charAt(0) || 'م' }}</div>
              <div class="author-info">
                <div class="author-name">{{ post.author }}</div>
                <div class="author-meta">
                  <span class="author-role">{{ post.authorRole || 'رائد أعمال' }}</span>
                  <span class="dot">·</span>
                  <span class="post-time">{{ post.timeAgo }}</span>
                </div>
              </div>
            </div>
            <!-- زر الحذف — يظهر عبر isMyPost() الذي يتحقق من currentUser.id -->
            <button class="del-btn" *ngIf="isMyPost(post)" (click)="deletePost(post)">
              <i class="bi bi-trash3"></i>
            </button>
          </div>

          <!-- محتوى المنشور -->
          <div class="post-body">
            <div class="post-title" *ngIf="post.title">{{ post.title }}</div>
            <p class="post-content">{{ post.content }}</p>
            <!-- الوسوم — النقر يستدعي filterByTag() الذي يُحدّث searchQuery و applyFilters() -->
            <div class="post-tags" *ngIf="post.tags && post.tags.length">
              <span class="ptag" *ngFor="let tag of post.tags" (click)="filterByTag(tag)">#{{ tag }}</span>
            </div>
          </div>

          <!-- تذييل المنشور -->
          <div class="post-foot">
            <!-- الإعجاب — يُحدّث post.isLiked و post.likesCount و summaryCards[2].value عبر toggleLike() -->
            <button class="act-btn" [class.liked]="post.isLiked" (click)="toggleLike(post)">
              <i class="bi" [class.bi-heart]="!post.isLiked" [class.bi-heart-fill]="post.isLiked"></i>
              {{ post.likesCount || 0 }}
            </button>
            <!-- التعليقات — تُحمَّل عبر loadComments() (API: GET /posts/:id/comments) -->
            <button class="act-btn" (click)="toggleComments(post)">
              <i class="bi bi-chat"></i>
              {{ post.commentsCount || 0 }}
            </button>
            <button class="act-btn share-btn">
              <i class="bi bi-share"></i>
              مشاركة
            </button>
          </div>

          <!-- قسم التعليقات
               التعليقات تأتي من API: GET /community/posts/:id/comments
               الإرسال عبر addComment() إلى: POST /community/posts/:id/comments
               post.commentsCount (في تذييل المنشور أعلاه) يُحدَّث بعد الإرسال الناجح
          -->
          <div class="comments-section" *ngIf="post.showComments">
            <div class="comment-loading" *ngIf="post.loadingComments">
              <i class="bi bi-arrow-repeat spin-icon"></i> جاري التحميل...
            </div>
            <div class="comments-list" *ngIf="!post.loadingComments">
              <div class="comment-item" *ngFor="let comment of post.comments">
                <div class="comment-avatar">{{ comment.User?.name?.charAt(0) || 'م' }}</div>
                <div class="comment-body">
                  <div class="comment-author">{{ comment.User?.name || 'مستخدم' }}</div>
                  <div class="comment-text">{{ comment.content }}</div>
                </div>
              </div>
              <div class="no-comments" *ngIf="!post.comments?.length">لا توجد تعليقات بعد. كن أول من يعلق!</div>
            </div>
            <div class="add-comment">
              <input type="text" [(ngModel)]="newCommentContent[post.id!]"
                (keyup.enter)="addComment(post)"
                placeholder="أضف تعليقاً..." class="comment-input">
              <button class="send-btn" (click)="addComment(post)">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>
          </div>

        </div>
      </div>

      <ng-template #noPosts>
        <div class="empty-state">
          <i class="bi bi-file-earmark-text empty-icon"></i>
          <p>لا توجد منشورات حالياً. كن أول من ينشر!</p>
          <button class="btn-primary" (click)="openNewPostModal()">إنشاء منشور</button>
        </div>
      </ng-template>

    </div><!-- end posts-col -->

    <!-- ===== SIDEBAR ===== -->
    <aside class="comm-sidebar">

      <!-- المواضيع الشائعة
           مشتقة من allPosts عبر computeTopics() — تحسب تكرار كل وسم
           النقر على موضوع يستدعي filterByTag() الذي يُحدّث posts في قسم POSTS أعلاه
      -->
      <div class="side-card">
        <div class="side-head">
          <div class="side-title"><i class="bi bi-tags"></i> المواضيع الشائعة</div>
        </div>
        <div class="topics-list" *ngIf="topTopics.length > 0; else noTopics">
          <div class="topic-item" *ngFor="let topic of topTopics; let i = index"
            (click)="filterByTag(topic.name)">
            <div class="topic-rank">#{{ i + 1 }}</div>
            <div class="topic-info">
              <div class="topic-name">#{{ topic.name }}</div>
              <div class="topic-posts">{{ topic.posts }} منشور</div>
            </div>
            <div class="topic-bar-wrap">
              <div class="topic-bar" [style.width.%]="(topic.posts / topTopics[0].posts) * 100"></div>
            </div>
          </div>
        </div>
        <ng-template #noTopics>
          <div class="empty-mini">لا توجد مواضيع بعد</div>
        </ng-template>
      </div>

      <!-- الأعضاء النشطون
           يأتون من activeMembers المُحمَّلة عبر loadActiveMembers() (API: GET /community/stats)
           member.posts يأخذ قيمته من استجابة الـ API
      -->
      <div class="side-card">
        <div class="side-head">
          <div class="side-title"><i class="bi bi-people"></i> الأعضاء النشطون</div>
        </div>
        <div class="members-list">
          <div class="member-row" *ngFor="let member of activeMembers">
            <div class="mem-avatar">{{ member.name.charAt(0) }}</div>
            <div class="mem-info">
              <div class="mem-name">{{ member.name }}</div>
              <div class="mem-posts">{{ member.posts }} منشور</div>
            </div>
            <div class="mem-badge">
              <i class="bi bi-trophy-fill"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- شارك الآن — يفتح موديل الإنشاء -->
      <div class="side-card">
        <div class="side-head">
          <div class="side-title"><i class="bi bi-pencil-square"></i> شارك الآن</div>
        </div>
        <p class="quick-desc">لديك فكرة أو سؤال؟ شاركه مع المجتمع!</p>
        <button class="btn-post-now" (click)="openNewPostModal()">
          <i class="bi bi-plus-circle"></i>
          إنشاء منشور جديد
        </button>
      </div>

    </aside>

  </div><!-- end content-layout -->

</main>

<!-- ===== NEW POST MODAL
     يُرسل البيانات عبر createPost() إلى API: POST /community/posts
     newPost.title، newPost.content، newPost.tags تُضاف لـ allPosts بعد النجاح
     ويُحدَّث summaryCards[0].value و topTopics عبر computeTopics()
===== -->
<div class="modal-overlay" *ngIf="showNewPostModal" (click)="closeNewPostModal()">
  <div class="modal-container modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-pencil-square"></i> منشور جديد</h3>
      <button class="close-btn" (click)="closeNewPostModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">عنوان المنشور</label>
        <input type="text" [(ngModel)]="newPost.title"
          placeholder="اكتب عنواناً جذاباً..." class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">المحتوى *</label>
        <textarea [(ngModel)]="newPost.content"
          placeholder="شارك أفكارك، خبراتك، أو أسئلتك..."
          rows="5" class="form-input"></textarea>
      </div>
      <!-- الوسوم المختارة تُحفظ في newPost.tags وتُرسَل مع المنشور للـ API -->
      <div class="form-group">
        <label class="form-label">الوسوم</label>
        <div class="tags-grid">
          <button type="button" *ngFor="let tag of availableTags"
            (click)="toggleTag(tag)"
            class="tag-btn" [class.tag-active]="newPost.tags.includes(tag)">
            #{{ tag }}
          </button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeNewPostModal()" [disabled]="isCreatingPost">إلغاء</button>
      <button class="btn-primary" (click)="createPost()" [disabled]="isCreatingPost">
        <i class="bi bi-send" *ngIf="!isCreatingPost"></i>
        <i class="bi bi-arrow-repeat spin-icon" *ngIf="isCreatingPost"></i>
        {{ isCreatingPost ? 'جاري النشر...' : 'نشر المنشور' }}
      </button>
    </div>
  </div>
</div>