<app-side-bar #sidebarRef (collapsedChange)="onSidebarToggle($event)"></app-side-bar>

<!-- ===== TOP NAV ===== -->
<nav class="top-nav" [class.sidebar-collapsed]="isSidebarCollapsed">
  <div class="nav-content">
    <div class="nav-left">
      <div>
        <div class="nav-page-title">ุงููุฌุชูุน</div>
        <div class="nav-page-sub">ุดุงุฑู ุฃููุงุฑู ูุชูุงุตู ูุน ุฑูุงุฏ ุงูุฃุนูุงู ุงูุขุฎุฑูู</div>
      </div>
    </div>
    <div class="nav-right">
      <div class="search-wrap desktop-only-flex">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.099zm-5.242 1.656a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11"/></svg>
        <input type="text" [(ngModel)]="searchQuery" (input)="searchPosts()"
          placeholder="ุงุจุญุซ ูู ุงูููุดูุฑุงุช..." class="search-input">
      </div>
      <button class="btn-add" (click)="openNewPostModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>
        <span class="btn-text">ููุดูุฑ ุฌุฏูุฏ</span>
      </button>
      <button class="guide-btn" (click)="openGuide()">
        <svg viewBox="0 0 16 16" fill="white"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg>
        <span class="btn-text">ุฏููู ุงูุงุณุชุฎุฏุงู</span>
      </button>
      <!-- ุฒุฑ ุงููุงูุจุฑุฌุฑ โ ูุธูุฑ ููุท ุนูู ููุจุงูู/ุชุงุจูุช -->
      <button class="topnav-hamburger" (click)="openSidebar()" aria-label="ูุชุญ ุงููุงุฆูุฉ">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</nav>

<!-- ===== GUIDE MODAL ===== -->
<div class="modal-overlay" *ngIf="showGuide" (click)="closeGuide()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>๐ฌ ุฏููู ุงุณุชุฎุฏุงู ุงููุฌุชูุน</h3>
      <button class="close-btn" (click)="closeGuide()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">ุงูุถู ููุฌุชูุน ุฑูุงุฏ ุงูุฃุนูุงู ูุดุงุฑู ุฎุจุฑุงุชู ูุงุณุชูุฏ ูู ุชุฌุงุฑุจ ุงูุขุฎุฑูู.</p>
      <div class="guide-features">
        <div class="guide-item"><span class="guide-icon">โ๏ธ</span><div><h4>ุงููุดุฑ ูุงููุดุงุฑูุฉ</h4><p>ุดุงุฑู ุฃููุงุฑู ูุชุฌุงุฑุจู ูุน ุงููุฌุชูุน</p></div></div>
        <div class="guide-item"><span class="guide-icon">โค๏ธ</span><div><h4>ุงูุชูุงุนู</h4><p>ุฃุนุฌุจ ุจุงูููุดูุฑุงุช ูุนูู ุนูู ูุง ูููู</p></div></div>
        <div class="guide-item"><span class="guide-icon">๐ท๏ธ</span><div><h4>ุงููุณูู</h4><p>ุงุณุชุฎุฏู ุงููุณูู ูููุตูู ูููุญุชูู ุงูููุงุณุจ</p></div></div>
        <div class="guide-item"><span class="guide-icon">๐</span><div><h4>ุงูุจุญุซ</h4><p>ุงุจุญุซ ุนู ููุดูุฑุงุช ุจูููุงุช ููุชุงุญูุฉ ุฃู ูุณูู</p></div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeGuide()">ูููุชุ ุดูุฑุงู</button>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<main class="community-main" [class.sidebar-collapsed]="isSidebarCollapsed">

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner"><div class="spinner"></div><p>ุฌุงุฑู ุชุญููู ุงููุฌุชูุน...</p></div>
  </div>

  <!-- Messages -->
  <div class="success-banner" *ngIf="successMessage">
    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M6.97 11.03a.75.75 0 0 0 1.08.022l3.992-4.99a.75.75 0 0 0-1.071-1.05L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06z"/></svg>
    {{ successMessage }}
  </div>
  <div class="error-banner" *ngIf="errorMessage">
    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg>
    {{ errorMessage }}
  </div>

  <!-- ===== WELCOME ===== -->
  <section class="welcome-section">
    <div class="welcome-content">
      <div class="welcome-text">
        <h1 class="welcome-title">ูุฌุชูุน ุฎุทูุฉ <span>๐ฌ</span></h1>
        <p class="welcome-sub">ุชูุงุตู ูุน ุฑูุงุฏ ุงูุฃุนูุงู ูุดุงุฑู ุงูุฎุจุฑุงุช ูุงูุฃููุงุฑ</p>
      </div>
      <div class="welcome-badges">
        <div class="w-badge">
          <span class="w-badge-icon">๐</span>
          <div>
            <span class="w-badge-lbl">ุฅุฌูุงูู ุงูููุดูุฑุงุช</span>
            <span class="w-badge-val">{{ summaryCards[0]?.value || 0 }}</span>
          </div>
        </div>
        <div class="w-badge">
          <span class="w-badge-icon">๐ฅ</span>
          <div>
            <span class="w-badge-lbl">ุฃุนุถุงุก ูุดุทูู</span>
            <span class="w-badge-val">{{ summaryCards[1]?.value || 0 }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== METRICS ===== -->
  <section class="metrics-grid">
    <div class="mc" *ngFor="let card of summaryCards">
      <div class="mc-icon">{{ card.icon }}</div>
      <div class="mc-lbl">{{ card.title }}</div>
      <div class="mc-val" *ngIf="!card.loading">{{ card.value }}</div>
      <div class="mc-skeleton" *ngIf="card.loading"></div>
      <div class="mini-prog"><div class="mini-prog-fill g" style="width:65%"></div></div>
    </div>
    <div class="mc">
      <div class="mc-icon">๐ฅ</div>
      <div class="mc-lbl">ููุดูุฑุงุช ุงูููู</div>
      <div class="mc-val">{{ posts.length }}</div>
      <div class="mini-prog"><div class="mini-prog-fill o" style="width:80%"></div></div>
    </div>
  </section>

  <!-- ===== CONTENT LAYOUT ===== -->
  <div class="content-layout">

    <!-- ===== POSTS COLUMN ===== -->
    <div class="posts-col">

      <!-- Filters -->
      <div class="filters-bar">
        <div class="filter-tabs">
          <button *ngFor="let f of availableFilters"
            (click)="changeFilter(f.value)"
            [class.active]="selectedFilter === f.value"
            class="ftab">
            {{ f.icon }} {{ f.label }}
          </button>
        </div>
      </div>

      <!-- Posts -->
      <div class="posts-list" *ngIf="posts.length > 0; else noPosts">
        <div class="post-card" *ngFor="let post of posts">

          <!-- Post Header -->
          <div class="post-head">
            <div class="author-wrap">
              <div class="author-avatar">{{ post.author?.charAt(0) || 'ู' }}</div>
              <div class="author-info">
                <div class="author-name">{{ post.author }}</div>
                <div class="author-meta">
                  <span class="author-role">{{ post.authorRole || 'ุฑุงุฆุฏ ุฃุนูุงู' }}</span>
                  <span class="dot">ยท</span>
                  <span class="post-time">{{ post.timeAgo }}</span>
                </div>
              </div>
            </div>
            <button class="del-btn" *ngIf="isMyPost(post)" (click)="deletePost(post)">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
            </button>
          </div>

          <!-- Post Body -->
          <div class="post-body">
            <div class="post-title" *ngIf="post.title">{{ post.title }}</div>
            <p class="post-content">{{ post.content }}</p>
            <div class="post-tags" *ngIf="post.tags && post.tags.length">
              <span class="ptag" *ngFor="let tag of post.tags" (click)="filterByTag(tag)">#{{ tag }}</span>
            </div>
          </div>

          <!-- Post Footer -->
          <div class="post-foot">
            <button class="act-btn" [class.liked]="post.isLiked" (click)="toggleLike(post)">
              <svg viewBox="0 0 16 16" fill="currentColor">
                <path *ngIf="!post.isLiked" d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01z"/>
                <path *ngIf="post.isLiked" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
              </svg>
              {{ post.likesCount || 0 }}
            </button>
            <button class="act-btn" (click)="toggleComments(post)">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>
              {{ post.commentsCount || 0 }}
            </button>
            <button class="act-btn share-btn">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5"/></svg>
              ูุดุงุฑูุฉ
            </button>
          </div>

          <!-- Comments -->
          <div class="comments-section" *ngIf="post.showComments">
            <div class="comment-loading" *ngIf="post.loadingComments">ุฌุงุฑู ุงูุชุญููู...</div>
            <div class="comments-list" *ngIf="!post.loadingComments">
              <div class="comment-item" *ngFor="let comment of post.comments">
                <div class="comment-avatar">{{ comment.User?.name?.charAt(0) || 'ู' }}</div>
                <div class="comment-body">
                  <div class="comment-author">{{ comment.User?.name || 'ูุณุชุฎุฏู' }}</div>
                  <div class="comment-text">{{ comment.content }}</div>
                </div>
              </div>
              <div class="no-comments" *ngIf="!post.comments?.length">ูุง ุชูุฌุฏ ุชุนูููุงุช ุจุนุฏ. ูู ุฃูู ูู ูุนูู!</div>
            </div>
            <div class="add-comment">
              <input type="text" [(ngModel)]="newCommentContent[post.id!]"
                (keyup.enter)="addComment(post)"
                placeholder="ุฃุถู ุชุนูููุงู..." class="comment-input">
              <button class="send-btn" (click)="addComment(post)">
                <svg viewBox="0 0 16 16" fill="currentColor"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11z"/></svg>
              </button>
            </div>
          </div>

        </div>
      </div>

      <ng-template #noPosts>
        <div class="empty-state">
          <div class="empty-icon">๐</div>
          <p>ูุง ุชูุฌุฏ ููุดูุฑุงุช ุญุงููุงู. ูู ุฃูู ูู ููุดุฑ!</p>
          <button class="btn-primary" (click)="openNewPostModal()">ุฅูุดุงุก ููุดูุฑ</button>
        </div>
      </ng-template>

    </div><!-- end posts-col -->

    <!-- ===== SIDEBAR ===== -->
    <aside class="comm-sidebar">

      <!-- Top Topics -->
      <div class="side-card">
        <div class="side-head">
          <div class="side-title">๐ท๏ธ ุงูููุงุถูุน ุงูุดุงุฆุนุฉ</div>
        </div>
        <div class="topics-list" *ngIf="topTopics.length > 0; else noTopics">
          <div class="topic-item" *ngFor="let topic of topTopics; let i = index"
            (click)="filterByTag(topic.name)">
            <div class="topic-rank">#{{ i + 1 }}</div>
            <div class="topic-info">
              <div class="topic-name">#{{ topic.name }}</div>
              <div class="topic-posts">{{ topic.posts }} ููุดูุฑ</div>
            </div>
            <div class="topic-bar-wrap">
              <div class="topic-bar" [style.width.%]="(topic.posts / topTopics[0].posts) * 100"></div>
            </div>
          </div>
        </div>
        <ng-template #noTopics>
          <div class="empty-mini">ูุง ุชูุฌุฏ ููุงุถูุน ุจุนุฏ</div>
        </ng-template>
      </div>

      <!-- Active Members -->
      <div class="side-card">
        <div class="side-head">
          <div class="side-title">๐ฅ ุงูุฃุนุถุงุก ุงููุดุทูู</div>
        </div>
        <div class="members-list">
          <div class="member-row" *ngFor="let member of activeMembers">
            <div class="mem-avatar">{{ member.name.charAt(0) }}</div>
            <div class="mem-info">
              <div class="mem-name">{{ member.name }}</div>
              <div class="mem-posts">{{ member.posts }} ููุดูุฑ</div>
            </div>
            <div class="mem-badge">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5q0 .807-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33 33 0 0 1 2.5.5"/></svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Post -->
      <div class="side-card">
        <div class="side-head">
          <div class="side-title">โ๏ธ ุดุงุฑู ุงูุขู</div>
        </div>
        <p class="quick-desc">ูุฏูู ููุฑุฉ ุฃู ุณุคุงูุ ุดุงุฑูู ูุน ุงููุฌุชูุน!</p>
        <button class="btn-post-now" (click)="openNewPostModal()">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>
          ุฅูุดุงุก ููุดูุฑ ุฌุฏูุฏ
        </button>
      </div>

    </aside>

  </div><!-- end content-layout -->

</main>

<!-- ===== NEW POST MODAL ===== -->
<div class="modal-overlay" *ngIf="showNewPostModal" (click)="closeNewPostModal()">
  <div class="modal-container modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>โ๏ธ ููุดูุฑ ุฌุฏูุฏ</h3>
      <button class="close-btn" (click)="closeNewPostModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">ุนููุงู ุงูููุดูุฑ</label>
        <input type="text" [(ngModel)]="newPost.title"
          placeholder="ุงูุชุจ ุนููุงูุงู ุฌุฐุงุจุงู..." class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">ุงููุญุชูู *</label>
        <textarea [(ngModel)]="newPost.content"
          placeholder="ุดุงุฑู ุฃููุงุฑูุ ุฎุจุฑุงุชูุ ุฃู ุฃุณุฆูุชู..."
          rows="5" class="form-input"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">ุงููุณูู</label>
        <div class="tags-grid">
          <button type="button" *ngFor="let tag of availableTags"
            (click)="toggleTag(tag)"
            class="tag-btn" [class.tag-active]="newPost.tags.includes(tag)">
            #{{ tag }}
          </button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeNewPostModal()" [disabled]="isCreatingPost">ุฅูุบุงุก</button>
      <button class="btn-primary" (click)="createPost()" [disabled]="isCreatingPost">
        {{ isCreatingPost ? 'ุฌุงุฑู ุงููุดุฑ...' : 'ูุดุฑ ุงูููุดูุฑ' }}
      </button>
    </div>
  </div>
</div>