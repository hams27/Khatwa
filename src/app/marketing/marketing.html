<app-side-bar #sidebarRef (collapsedChange)="onSidebarToggle($event)"></app-side-bar>
<app-ai-chat></app-ai-chat>

<!-- ===== TOP NAV ===== -->
<nav class="top-nav" [class.sidebar-collapsed]="isSidebarCollapsed">
  <div class="nav-content">
    <div class="nav-left">
      <div>
        <div class="nav-page-title">الخطة التسويقية</div>
        <div class="nav-page-sub">خارطة طريق نحو نمو مشروعك وبناء حضور قوي</div>
      </div>
    </div>
    <div class="nav-right">
      <button class="guide-btn" (click)="openGuide()">
        <i class="bi bi-info-circle"></i>
        <span class="btn-text">دليل الاستخدام</span>
      </button>
      <button class="topnav-hamburger" (click)="openSidebar()" aria-label="فتح القائمة">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>
</nav>

<!-- ===== GUIDE MODAL ===== -->
<div class="modal-overlay" *ngIf="showGuide" (click)="closeGuide()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-megaphone"></i> دليل استخدام الخطة التسويقية</h3>
      <button class="close-btn" (click)="closeGuide()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">الخطة التسويقية تساعدك على بناء حضور قوي وزيادة التفاعل مع عملائك.</p>
      <div class="guide-features">
        <div class="guide-item">
          <i class="bi bi-bar-chart-line guide-icon"></i>
          <div><h4>متابعة التقدم</h4><p>تابع خطتك بشكل مرئي وواضح</p></div>
        </div>
        <div class="guide-item">
          <i class="bi bi-lightbulb guide-icon"></i>
          <div><h4>أفكار محتوى ذكية</h4><p>اقتراحات بالذكاء الاصطناعي</p></div>
        </div>
        <div class="guide-item">
          <i class="bi bi-calendar3 guide-icon"></i>
          <div><h4>جدولة المحتوى</h4><p>نظم ونشر المحتوى على جميع المنصات</p></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="closeGuide()">فهمت، شكراً</button>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<main class="marketing-main" [class.sidebar-collapsed]="isSidebarCollapsed">

  <!-- ===== WELCOME
       totalEngagement ← METRICS: نفس قيمة totalEngagement المحسوبة في loadStats()
       API: GET /api/v1/marketing/stats
  ===== -->
  <section class="welcome-section">
    <div class="welcome-content">
      <div class="welcome-text">
        <h1 class="welcome-title">خطتك التسويقية <i class="bi bi-rocket-takeoff"></i></h1>
        <p class="welcome-sub">إدارة حضورك الرقمي وتنمية جمهورك باحترافية</p>
      </div>
      <div class="welcome-badges">
        <!-- يأخذ totalEngagement من نفس متغير قسم METRICS -->
        <div class="w-badge">
          <i class="bi bi-heart-fill w-badge-icon"></i>
          <div>
            <span class="w-badge-lbl">إجمالي التفاعل</span>
            <span class="w-badge-val">{{ totalEngagement }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== METRICS
       publishedContent  ← loadStats() → API: GET /api/v1/marketing/stats
       scheduledContent  ← loadStats()
       totalEngagement   ← loadStats() — نفس القيمة المعروضة في WELCOME
       contentGrowth     ← loadStats()
       engagementProgress← loadStats()
  ===== -->
  <section class="metrics-grid">

    <div class="mc published">
      <div class="mc-icon"><i class="bi bi-check-circle"></i></div>
      <div class="mc-lbl">محتوى منشور</div>
      <div class="mc-val">{{ publishedContent }}</div>
      <div class="mc-trend up" *ngIf="contentGrowth > 0">
        <i class="bi bi-arrow-up"></i> {{ contentGrowth }}%
      </div>
      <div class="mini-prog"><div class="mini-prog-fill g"></div></div>
    </div>

    <div class="mc scheduled">
      <div class="mc-icon"><i class="bi bi-calendar-check"></i></div>
      <div class="mc-lbl">محتوى مجدول</div>
      <div class="mc-val">{{ scheduledContent }}</div>
      <div class="mc-sub">للأسبوع القادم</div>
      <!-- scheduledContent يتغير أيضاً عند confirmUseIdea() و confirmSchedulePost() في قسم IDEA MODAL و SCHEDULE MODAL -->
      <div class="mini-prog"><div class="mini-prog-fill b" style="width:60%"></div></div>
    </div>

    <div class="mc engagement">
      <div class="mc-icon"><i class="bi bi-heart"></i></div>
      <div class="mc-lbl">إجمالي التفاعل</div>
      <!-- totalEngagement يُعرض أيضاً في WELCOME -->
      <div class="mc-val">{{ totalEngagement }}</div>
      <div class="mini-prog"><div class="mini-prog-fill p" [style.width.%]="engagementProgress"></div></div>
    </div>

  </section>

  <!-- ===== CHARTS ROW
       monthlyContentData ← loadChartData() → API: GET /api/v1/marketing/chart-data
       channelsPerformance← loadChartData()
       كلا الشارتين تُبنى في createAllCharts() بعد تحميل البيانات
  ===== -->
  <div class="charts-row">

    <!-- أداء المحتوى: يستخدم monthlyContentData.months و .posts و .engagement -->
    <div class="chart-card wide">
      <div class="chart-head">
        <div>
          <div class="chart-title"><i class="bi bi-bar-chart"></i> أداء المحتوى</div>
          <div class="chart-sub">المنشورات والتفاعل خلال 6 أشهر</div>
        </div>
        <span class="chip chip-g"><i class="bi bi-arrow-up"></i> {{ contentGrowth }}%</span>
      </div>
      <div style="height:240px"><canvas #contentChart></canvas></div>
    </div>

    <!-- أداء القنوات: يستخدم channelsPerformance.labels و .data -->
    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-title"><i class="bi bi-reception-4"></i> أداء القنوات</div>
          <div class="chart-sub">مقارنة المنصات</div>
        </div>
      </div>
      <div style="height:240px"><canvas #channelsChart></canvas></div>
    </div>

  </div>

  <!-- ===== ENGAGEMENT TIMELINE
       dailyEngagement ← loadEngagementData() → API: GET /api/v1/marketing/engagement?days=30
       avgDailyEngagement و maxDailyEngagement محسوبتان من dailyEngagement[]
  ===== -->
  <div class="chart-card full-width" style="margin-bottom:24px">
    <div class="chart-head">
      <div>
        <div class="chart-title"><i class="bi bi-graph-up"></i> التفاعل اليومي</div>
        <div class="chart-sub">آخر 30 يوم</div>
      </div>
      <span class="chip chip-b">30 يوم</span>
    </div>
    <div style="height:200px"><canvas #engagementChart></canvas></div>
    <div class="chart-foot">
      <!-- avgDailyEngagement محسوبة من dailyEngagement[] في computeEngagementStats() -->
      <div><span class="cs-lbl">متوسط يومي</span><span class="cs-val s">{{ avgDailyEngagement }}</span></div>
      <!-- maxDailyEngagement محسوبة من dailyEngagement[] في computeEngagementStats() -->
      <div><span class="cs-lbl">أعلى يوم</span><span class="cs-val i">{{ maxDailyEngagement }}</span></div>
    </div>
  </div>

  <!-- ===== BOTTOM GRID ===== -->
  <div class="bottom-grid">

    <!-- ===== PLAN PROGRESS
         planProgress   ← loadPlanProgress() → API: GET /api/v1/marketing/plan-progress
         completedSteps ← loadPlanProgress()
         marketingSteps ← loadPlanProgress() — حالة كل خطوة (completed/active/pending)
    ===== -->
    <div class="card">
      <div class="card-head">
        <div class="card-title"><i class="bi bi-bar-chart-steps"></i> تقدم الخطة التسويقية</div>
        <!-- planProgress يُعرض هنا وداخل الدائرة المتحركة -->
        <span class="prog-pct">{{ planProgress }}%</span>
      </div>

      <div class="circ-wrap">
        <div class="circ-container">
          <svg class="circ-svg" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="mktGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%"   style="stop-color:#1d4ed8"/>
                <stop offset="100%" style="stop-color:#60a5fa"/>
              </linearGradient>
            </defs>
            <circle class="c-bg"   cx="60" cy="60" r="50"/>
            <circle class="c-fill" cx="60" cy="60" r="50"
              [style.stroke-dasharray]="314"
              [style.stroke-dashoffset]="314 - (314 * planProgress / 100)"/>
          </svg>
          <div class="circ-center">
            <div class="circ-pct">{{ planProgress }}%</div>
            <div class="circ-lbl">مكتمل</div>
          </div>
        </div>
      </div>

      <!-- marketingSteps — كل خطوة قابلة للنقر لتحديدها أو إلغاء تحديدها
           toggleStep(i) يُحدّث status الخطوة ويُعيد حساب planProgress والدائرة -->
      <div class="steps-list">
        <div class="step-row"
          *ngFor="let step of marketingSteps; let i = index"
          [class.done]="step.status === 'completed'"
          [class.active]="step.status === 'active'"
          [class.pending]="step.status === 'pending'"
          (click)="toggleStep(i)"
          [title]="step.status === 'completed' ? 'اضغط لإلغاء التحديد' : 'اضغط للتحديد كمكتمل'">
          <div class="step-num">
            <i class="bi bi-check-lg" *ngIf="step.status === 'completed'"></i>
            <i class="bi bi-arrow-repeat" *ngIf="step.status === 'active'"></i>
            <span *ngIf="step.status === 'pending'">{{ i + 1 }}</span>
          </div>
          <div class="step-info">
            <div class="step-name">{{ step.title }}</div>
            <div class="step-desc">{{ step.description }}</div>
          </div>
          <span class="step-badge" [class]="step.status">
            {{ step.status === 'completed' ? 'مكتمل' : step.status === 'active' ? 'جارٍ' : 'قادم' }}
          </span>
          <i class="bi step-toggle-hint"
            [class.bi-check-circle]="step.status !== 'completed'"
            [class.bi-x-circle]="step.status === 'completed'"></i>
        </div>
      </div>
    </div>

    <!-- ===== MID COLUMN ===== -->
    <div class="mid-col">

      <!-- ===== CONTENT SCHEDULE
           scheduledPosts ← loadScheduledPosts() → API: GET /api/v1/marketing/scheduled-posts
           عند confirmUseIdea() أو confirmSchedulePost() يُضاف منشور جديد هنا
           scheduledContent في METRICS يرتفع بنفس العملية
      ===== -->
      <div class="card">
        <div class="card-head">
          <div class="card-title"><i class="bi bi-calendar3"></i> جدول المحتوى</div>
          <button class="see-all" (click)="viewSchedule()">عرض الكل ›</button>
        </div>
        <div class="schedule-list" *ngIf="scheduledPosts.length > 0; else noSched">
          <div class="sched-item" *ngFor="let post of scheduledPosts">
            <div class="sched-dot" [class]="post.platform"></div>
            <div class="sched-info">
              <div class="sched-title">{{ post.title }}</div>
              <div class="sched-meta">
                <span class="sched-time">
                  <i class="bi bi-clock"></i> {{ post.scheduledTime }}
                </span>
                <span class="sched-plat" [class]="post.platform">{{ getPlatformLabel(post.platform) }}</span>
              </div>
            </div>
            <span class="sched-status" [class]="post.status">{{ getStatusLabel(post.status) }}</span>
          </div>
        </div>
        <ng-template #noSched>
          <div class="empty-state">
            <i class="bi bi-calendar-x empty-icon"></i>
            <p>لا توجد منشورات مجدولة</p>
            <button class="btn btn-secondary" (click)="createContent()">جدولة محتوى</button>
          </div>
        </ng-template>
      </div>

      <!-- ===== QUICK ACTIONS ===== -->
      <div class="card">
        <div class="card-head">
          <div class="card-title"><i class="bi bi-lightning-charge"></i> إجراءات سريعة</div>
        </div>
        <div class="actions-grid">
          <button class="act-btn analytics" (click)="viewAnalytics()">
            <i class="bi bi-bar-chart-line act-icon"></i>
            <span>تحليل الأداء</span>
          </button>
          <button class="act-btn schedule" (click)="viewSchedule()">
            <i class="bi bi-calendar-plus act-icon"></i>
            <span>جدولة المنشورات</span>
          </button>
          <button class="act-btn community" routerLink="/community">
            <i class="bi bi-people act-icon"></i>
            <span>المجتمع</span>
          </button>
        </div>
      </div>

    </div>

    <!-- ===== AI CONTENT IDEAS
         contentIdeas  ← loadContentIdeas() → API: GET /api/v1/marketing/content-ideas
         filteredIdeas ← مشتقة من contentIdeas عبر filterPlatform()
         عند generateAIContent() → API: POST /api/v1/marketing/generate-ideas
           تُضاف أفكار جديدة إلى contentIdeas ثم تُحدَّث filteredIdeas
    ===== -->
    <div class="card ideas-card">
      <div class="card-head">
        <div class="card-title"><i class="bi bi-lightbulb"></i> أفكار محتوى ذكية</div>
        <span class="ai-badge">AI</span>
      </div>

      <!-- تصفية المنصة — تُحدّث filteredIdeas من contentIdeas -->
      <div class="platform-tabs">
        <button class="ptab" [class.active]="activePlatformFilter === 'all'"       (click)="filterPlatform('all')">الكل</button>
        <button class="ptab" [class.active]="activePlatformFilter === 'instagram'" (click)="filterPlatform('instagram')">
          <i class="bi bi-instagram"></i> انستجرام
        </button>
        <button class="ptab" [class.active]="activePlatformFilter === 'facebook'"  (click)="filterPlatform('facebook')">
          <i class="bi bi-facebook"></i> فيسبوك
        </button>
        <button class="ptab" [class.active]="activePlatformFilter === 'linkedin'"  (click)="filterPlatform('linkedin')">
          <i class="bi bi-linkedin"></i> لينكد إن
        </button>
      </div>

      <!-- filteredIdeas مشتقة من contentIdeas بعد filterPlatform() -->
      <div class="ideas-list" *ngIf="filteredIdeas.length > 0; else noIdeas">
        <div class="idea-item" *ngFor="let idea of filteredIdeas" [class]="idea.priority">
          <div class="idea-plat">
            <i class="bi bi-{{ getPlatformBiIcon(idea.platform) }}"></i>
          </div>
          <div class="idea-body">
            <div class="idea-title">{{ idea.title }}</div>
            <div class="idea-desc">{{ idea.description }}</div>
            <div class="idea-tags">
              <span class="itag pri" [class]="idea.priority">{{ getPriorityLabel(idea.priority) }}</span>
              <span class="itag type">{{ idea.type }}</span>
            </div>
          </div>
          <!-- useIdea() تفتح IDEA MODAL مع الفكرة المختارة -->
          <button class="idea-use" (click)="useIdea(idea)">
            <i class="bi bi-arrow-left"></i>
          </button>
        </div>
      </div>

      <ng-template #noIdeas>
        <div class="empty-state">
          <i class="bi bi-lightbulb empty-icon"></i>
          <p>لا توجد أفكار — اضغط توليد</p>
        </div>
      </ng-template>

      <!-- يستدعي generateAIContent() → API: POST /api/v1/marketing/generate-ideas -->
      <button class="btn-generate" (click)="generateAIContent()" [class.spin]="isGeneratingAI">
        <i class="bi bi-arrow-repeat" [class.spin-icon]="isGeneratingAI"></i>
        {{ isGeneratingAI ? 'جاري التوليد...' : 'توليد أفكار جديدة' }}
      </button>
    </div>

  </div><!-- end bottom-grid -->

</main>

<!-- ===== IDEA MODAL
     selectedIdea ← من useIdea(idea) في قسم AI CONTENT IDEAS
     confirmUseIdea() يُضيف منشوراً جديداً لـ scheduledPosts في قسم CONTENT SCHEDULE
     ويرفع scheduledContent في قسم METRICS
===== -->
<div class="modal-overlay" *ngIf="showIdeaModal" (click)="closeIdeaModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-lightbulb"></i> استخدام فكرة المحتوى</h3>
      <button class="close-btn" (click)="closeIdeaModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body" *ngIf="selectedIdea">
      <div class="idea-preview-card">
        <div class="idea-preview-plat">
          <i class="bi bi-{{ getPlatformBiIcon(selectedIdea.platform) }}"></i>
          {{ getPlatformLabel(selectedIdea.platform) }}
        </div>
        <div class="idea-preview-title">{{ selectedIdea.title }}</div>
        <div class="idea-preview-desc">{{ selectedIdea.description }}</div>
        <div class="idea-tags" style="margin-top:8px">
          <span class="itag pri" [class]="selectedIdea.priority">{{ getPriorityLabel(selectedIdea.priority) }}</span>
          <span class="itag type">{{ selectedIdea.type }}</span>
        </div>
      </div>
      <p class="guide-intro" style="margin-top:16px">هل تريد إضافة هذه الفكرة كمسودة في جدول المحتوى؟</p>
    </div>
    <div class="modal-footer" style="gap:10px; display:flex; justify-content:flex-end;">
      <button class="btn btn-secondary" (click)="closeIdeaModal()">إلغاء</button>
      <!-- يُحدّث scheduledPosts (CONTENT SCHEDULE) و scheduledContent (METRICS) -->
      <button class="btn btn-primary" (click)="confirmUseIdea()">
        <i class="bi bi-calendar-plus"></i> إضافة للجدول
      </button>
    </div>
  </div>
</div>

<!-- ===== SCHEDULE MODAL
     newPostTitle / newPostPlatform / newPostTime ← حقول الإدخال
     confirmSchedulePost() يُضيف منشوراً جديداً لـ scheduledPosts في CONTENT SCHEDULE
     ويرفع scheduledContent في METRICS
===== -->
<div class="modal-overlay" *ngIf="showScheduleModal" (click)="closeScheduleModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-calendar-plus"></i> جدولة منشور جديد</h3>
      <button class="close-btn" (click)="closeScheduleModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">عنوان المنشور</label>
        <input class="form-input" type="text" [(ngModel)]="newPostTitle" placeholder="اكتب عنوان المنشور...">
      </div>
      <div class="form-group">
        <label class="form-label">المنصة</label>
        <select class="form-input" [(ngModel)]="newPostPlatform">
          <option value="instagram">إنستجرام</option>
          <option value="facebook">فيسبوك</option>
          <option value="twitter">تويتر</option>
          <option value="linkedin">لينكد إن</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">وقت النشر</label>
        <input class="form-input" type="text" [(ngModel)]="newPostTime" placeholder="مثال: غداً - 10:00 ص">
      </div>
    </div>
    <div class="modal-footer" style="gap:10px; display:flex; justify-content:flex-end;">
      <button class="btn btn-secondary" (click)="closeScheduleModal()">إلغاء</button>
      <!-- يُحدّث scheduledPosts (CONTENT SCHEDULE) و scheduledContent (METRICS) -->
      <button class="btn btn-primary" (click)="confirmSchedulePost()" [disabled]="!newPostTitle.trim()">
        <i class="bi bi-calendar-check"></i> جدولة المنشور
      </button>
    </div>
  </div>
</div>