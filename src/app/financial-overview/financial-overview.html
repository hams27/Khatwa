<app-side-bar #sidebarRef (collapsedChange)="onSidebarToggle($event)"></app-side-bar>
<app-ai-chat></app-ai-chat>

<!-- TOP NAV -->
<nav class="top-nav" [class.sidebar-collapsed]="isSidebarCollapsed">
  <div class="nav-content">
    <div class="nav-left">
      <div>
        <div class="nav-page-title">الحسابات المالية</div>
        <div class="nav-page-sub">تتبع إيراداتك ومصروفاتك وأرباحك بشكل احترافي</div>
      </div>
    </div>
    <div class="nav-right">
      <div class="period-selector desktop-only-flex">
        <button (click)="changePeriod('week')"    [class.active]="selectedPeriod==='week'"    class="period-btn">أسبوع</button>
        <button (click)="changePeriod('month')"   [class.active]="selectedPeriod==='month'"   class="period-btn">شهر</button>
        <button (click)="changePeriod('quarter')" [class.active]="selectedPeriod==='quarter'" class="period-btn">ربع سنة</button>
        <button (click)="changePeriod('year')"    [class.active]="selectedPeriod==='year'"    class="period-btn">سنة</button>
      </div>
      <button class="btn-add" (click)="refreshFinancialData()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
        <span class="btn-text">تحديث</span>
      </button>
      <button class="guide-btn" (click)="openGuide()">
        <svg viewBox="0 0 16 16" fill="white"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg>
        <span class="btn-text">دليل الاستخدام</span>
      </button>
      <button class="topnav-hamburger" (click)="openSidebar()" aria-label="فتح القائمة">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</nav>

<!-- GUIDE MODAL -->
<div class="modal-overlay" *ngIf="showGuide" (click)="closeGuide()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-cash-stack"></i> دليل استخدام الحسابات المالية</h3>
      <button class="close-btn" (click)="closeGuide()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">صفحة الحسابات المالية تمنحك رؤية شاملة عن الوضع المالي لمشروعك.</p>
      <div class="guide-features">
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-bar-chart-fill"></i></span><div><h4>متابعة الإيرادات</h4><p>أضف إيراداتك واضغط "إضافة إيراد" لتسجيلها</p></div></div>
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-cash"></i></span><div><h4>إدارة المصروفات</h4><p>سجّل مصروفاتك واضغط "تسجيل مصروف"</p></div></div>
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-graph-up-arrow"></i></span><div><h4>حساب الأرباح تلقائياً</h4><p>الأرباح = الإيرادات - المصروفات تُحسب فوراً</p></div></div>
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-arrow-repeat"></i></span><div><h4>سجل المعاملات</h4><p>استعرض جميع العمليات المالية بالتفصيل</p></div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="closeGuide()">فهمت، شكراً</button>
    </div>
  </div>
</div>

<!-- ===== ADD TRANSACTION MODAL ===== -->
<div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
  <div class="modal-container add-modal" (click)="$event.stopPropagation()">

    <div class="modal-header" [class.header-revenue]="addModalType==='revenue'" [class.header-expense]="addModalType==='expense'">
      <h3>
        <span *ngIf="addModalType==='revenue'"><i class="bi bi-cash-stack"></i> إضافة إيراد جديد</span>
        <span *ngIf="addModalType==='expense'"><i class="bi bi-cash"></i> تسجيل مصروف جديد</span>
      </h3>
      <button class="close-btn" (click)="closeAddModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>

    <div class="modal-body">

      <!-- العنوان -->
      <div class="form-group" [class.has-error]="formErrors.title">
        <label class="form-label">
          <span>
            <span *ngIf="addModalType==='revenue'">عنوان الإيراد</span>
            <span *ngIf="addModalType==='expense'">عنوان المصروف</span>
            <span class="required">*</span>
          </span>
          <span class="field-error" *ngIf="formErrors.title">{{ formErrors.title }}</span>
        </label>
        <input
          type="text"
          class="form-input"
          [(ngModel)]="newTransaction.title"
          [placeholder]="addModalType==='revenue' ? 'مثال: عقد تصميم موقع' : 'مثال: فاتورة إيجار المكتب'"
          maxlength="100">
      </div>

      <!-- المبلغ -->
      <div class="form-group" [class.has-error]="formErrors.amount">
        <label class="form-label">
          <span>المبلغ (ر.س) <span class="required">*</span></span>
          <span class="field-error" *ngIf="formErrors.amount">{{ formErrors.amount }}</span>
        </label>
        <div class="input-with-icon">
          <input
            type="number"
            class="form-input"
            [(ngModel)]="newTransaction.amount"
            placeholder="0.00"
            min="0.01"
            step="0.01">
          <span class="input-suffix">ر.س</span>
        </div>
      </div>

      <!-- الفئة -->
      <div class="form-group" [class.has-error]="formErrors.category">
        <label class="form-label">
          <span>الفئة <span class="required">*</span></span>
          <span class="field-error" *ngIf="formErrors.category">{{ formErrors.category }}</span>
        </label>
        <select class="form-input form-select" [(ngModel)]="newTransaction.category">
          <option value="">-- اختر الفئة --</option>
          <option *ngFor="let cat of modalCategories" [value]="cat">{{ cat }}</option>
        </select>
      </div>

      <!-- التاريخ -->
      <div class="form-group">
        <label class="form-label">التاريخ</label>
        <input type="date" class="form-input" [(ngModel)]="newTransaction.date">
      </div>

      <!-- ملاحظات -->
      <div class="form-group">
        <label class="form-label">ملاحظات (اختياري)</label>
        <textarea
          class="form-input form-textarea"
          [(ngModel)]="newTransaction.description"
          placeholder="أي تفاصيل إضافية..."
          rows="2"
          maxlength="200"></textarea>
      </div>

      <!-- معاينة الأثر على الأرباح -->
      <div class="profit-preview" *ngIf="newTransaction.amount && newTransaction.amount > 0">
        <div class="pp-title"><i class="bi bi-bar-chart-fill"></i> الأثر على الأرباح</div>
        <div class="pp-row">
          <span>الأرباح الحالية</span>
          <span class="pp-val" [class.pos]="profit>=0" [class.neg]="profit<0">{{ formatCurrency(profit) }}</span>
        </div>
        <div class="pp-row">
          <span *ngIf="addModalType==='revenue'">+ إيراد جديد</span>
          <span *ngIf="addModalType==='expense'">- مصروف جديد</span>
          <span class="pp-val" [class.pos]="addModalType==='revenue'" [class.neg]="addModalType==='expense'">
            {{ addModalType==='revenue' ? '+' : '-' }}{{ formatCurrency(newTransaction.amount!) }}
          </span>
        </div>
        <div class="pp-divider"></div>
        <div class="pp-row pp-result">
          <span>الأرباح الجديدة</span>
          <span class="pp-val"
            [class.pos]="addModalType==='revenue' ? (profit + newTransaction.amount!) >= 0 : (profit - newTransaction.amount!) >= 0"
            [class.neg]="addModalType==='revenue' ? (profit + newTransaction.amount!) < 0 : (profit - newTransaction.amount!) < 0">
            {{ formatCurrency(addModalType==='revenue' ? profit + newTransaction.amount! : profit - newTransaction.amount!) }}
          </span>
        </div>
      </div>

    </div>

    <div class="modal-footer modal-footer-btns">
      <button class="btn-cancel" (click)="closeAddModal()" [disabled]="isSubmitting">إلغاء</button>
      <button
        class="btn-save"
        [class.btn-save-revenue]="addModalType==='revenue'"
        [class.btn-save-expense]="addModalType==='expense'"
        (click)="saveTransaction()"
        [disabled]="isSubmitting">
        <span *ngIf="!isSubmitting">
          <span *ngIf="addModalType==='revenue'"><i class="bi bi-cash-stack"></i> حفظ الإيراد</span>
          <span *ngIf="addModalType==='expense'"><i class="bi bi-cash"></i> حفظ المصروف</span>
        </span>
        <span *ngIf="isSubmitting">جاري الحفظ...</span>
      </button>
    </div>

  </div>
</div>

<!-- MAIN -->
<main class="finance-main" [class.sidebar-collapsed]="isSidebarCollapsed">

  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner"><div class="spinner"></div><p>جاري تحميل البيانات المالية...</p></div>
  </div>

  <div class="error-banner" *ngIf="errorMessage">
    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg>
    {{ errorMessage }}
  </div>

  <!-- رسالة النجاح -->
  <div class="success-banner" *ngIf="successMessage">
    {{ successMessage }}
  </div>

  <!-- WELCOME -->
  <section class="welcome-section">
    <div class="welcome-content">
      <div class="welcome-text">
        <h1 class="welcome-title">الحسابات المالية <span><i class="bi bi-cash-stack"></i></span></h1>
        <p class="welcome-sub">تحكم في أموالك وتتبع أداءك المالي باحترافية</p>
      </div>
      <div class="welcome-badges">
        <div class="w-badge">
          <span class="w-badge-icon"><i class="bi bi-graph-up-arrow"></i></span>
          <div><span class="w-badge-lbl">صافي الربح</span><span class="w-badge-val">{{ formatCurrency(profit) }}</span></div>
        </div>
        <div class="w-badge">
          <span class="w-badge-icon"><i class="bi bi-bar-chart-fill"></i></span>
          <div><span class="w-badge-lbl">هامش الربح</span><span class="w-badge-val">{{ profitMargin }}%</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- METRICS -->
  <section class="metrics-grid">
    <div class="mc mc-revenue">
      <div class="mc-icon"><i class="bi bi-cash-stack"></i></div>
      <div class="mc-lbl">إجمالي الإيرادات</div>
      <div class="mc-val">{{ cards[0]?.value || '0 ر.س' }}</div>
      <div class="mc-trend up" *ngIf="cards[0]?.up">↑ {{ cards[0]?.percent }}</div>
      <div class="mc-trend down" *ngIf="!cards[0]?.up">↓ {{ cards[0]?.percent }}</div>
      <div class="mini-prog"><div class="mini-prog-fill g" style="width:70%"></div></div>
    </div>
    <div class="mc mc-expenses">
      <div class="mc-icon"><i class="bi bi-cash"></i></div>
      <div class="mc-lbl">إجمالي المصروفات</div>
      <div class="mc-val">{{ cards[1]?.value || '0 ر.س' }}</div>
      <div class="mc-trend down">↑ {{ cards[1]?.percent }}</div>
      <div class="mini-prog"><div class="mini-prog-fill r" style="width:55%"></div></div>
    </div>
    <div class="mc mc-profit">
      <div class="mc-icon"><i class="bi bi-bar-chart-fill"></i></div>
      <div class="mc-lbl">صافي الربح</div>
      <div class="mc-val" [class.negative-val]="profit<0">{{ cards[2]?.value || '0 ر.س' }}</div>
      <div class="mc-trend up"   *ngIf="profit>=0">↑ {{ cards[2]?.percent }}</div>
      <div class="mc-trend down" *ngIf="profit<0">↓ {{ cards[2]?.percent }}</div>
      <div class="mini-prog"><div class="mini-prog-fill" [class.g]="profit>=0" [class.r]="profit<0" style="width:60%"></div></div>
    </div>
    <div class="mc mc-margin">
      <div class="mc-icon"><i class="bi bi-graph-down-arrow"></i></div>
      <div class="mc-lbl">هامش الربح</div>
      <div class="mc-val">{{ cards[3]?.value || '0%' }}</div>
      <div class="mc-sub">نسبة الكفاءة</div>
      <div class="mini-prog"><div class="mini-prog-fill p" [style.width.%]="profitMargin>0?profitMargin:10"></div></div>
    </div>
  </section>

  <!-- CHARTS -->
  <div class="charts-row">
    <div class="chart-card wide">
      <div class="chart-head">
        <div><div class="chart-title"><i class="bi bi-bar-chart-fill"></i> الإيرادات مقابل المصروفات</div><div class="chart-sub">مقارنة شاملة للفترة المحددة</div></div>
        <span class="chip chip-g" *ngIf="profit>0">↑ {{ profitMargin }}%</span>
        <span class="chip chip-r" *ngIf="profit<=0">↓ {{ profitMargin }}%</span>
      </div>
      <div style="height:240px"><canvas #revenueExpenseChart></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-head"><div><div class="chart-title"><i class="bi bi-pie-chart-fill"></i> توزيع المصروفات</div><div class="chart-sub">حسب الفئة</div></div></div>
      <div style="height:240px"><canvas #expenseDistributionChart></canvas></div>
    </div>
  </div>

  <div class="chart-card full-width" style="margin-bottom:16px">
    <div class="chart-head">
      <div><div class="chart-title"><i class="bi bi-graph-up-arrow"></i> الاتجاه الشهري</div><div class="chart-sub">الإيرادات والمصروفات على مدار الأشهر</div></div>
      <span class="chip chip-b">12 شهر</span>
    </div>
    <div style="height:220px"><canvas #monthlyTrendChart></canvas></div>
    <div class="chart-foot">
      <div><span class="cs-lbl">إجمالي الإيرادات</span><span class="cs-val s">{{ formatCurrency(totalRevenue) }}</span></div>
      <div><span class="cs-lbl">إجمالي المصروفات</span><span class="cs-val d">{{ formatCurrency(totalExpenses) }}</span></div>
      <div><span class="cs-lbl">صافي الربح</span><span class="cs-val" [class.s]="profit>=0" [class.d]="profit<0">{{ formatCurrency(profit) }}</span></div>
    </div>
  </div>

  <div class="chart-card full-width" style="margin-bottom:24px">
    <div class="chart-head"><div><div class="chart-title"><i class="bi bi-graph-down-arrow"></i> هامش الربح الشهري</div><div class="chart-sub">تطور نسبة الربحية</div></div></div>
    <div style="height:200px"><canvas #profitMarginChart></canvas></div>
  </div>

  <!-- BOTTOM GRID -->
  <div class="bottom-grid">

    <div class="card transactions-card">
      <div class="card-head">
        <div class="card-title"><i class="bi bi-receipt"></i> آخر المعاملات</div>
        <span class="tx-count">{{ transactions.length }} معاملة</span>
      </div>
      <div class="tx-list" *ngIf="transactions.length>0; else noTx">
        <div class="tx-item" *ngFor="let tx of transactions"
          [class.tx-revenue]="tx.type==='revenue'"
          [class.tx-expense]="tx.type==='expense'"
          [class.tx-pending]="tx.type==='pending'">
          <div class="tx-icon">
            <span *ngIf="tx.type==='revenue'"><i class="bi bi-cash-stack"></i></span>
            <span *ngIf="tx.type==='expense'"><i class="bi bi-cash"></i></span>
            <span *ngIf="tx.type==='pending'"><i class="bi bi-hourglass-split"></i></span>
          </div>
          <div class="tx-info">
            <div class="tx-title">{{ tx.title }}</div>
            <div class="tx-meta">
              <span class="tx-date"><i class="bi bi-clock"></i> {{ tx.date }}</span>
              <span class="tx-cat" *ngIf="tx.category">{{ tx.category }}</span>
            </div>
          </div>
          <div class="tx-amount" [class.amount-pos]="tx.amount>0" [class.amount-neg]="tx.amount<0">
            {{ tx.amount>0?'+':'' }}{{ tx.amount.toLocaleString('ar-SA') }} ر.س
          </div>
        </div>
      </div>
      <ng-template #noTx>
        <div class="empty-state"><div class="empty-icon"><i class="bi bi-inbox"></i></div><p>لا توجد معاملات مالية حتى الآن</p></div>
      </ng-template>
    </div>

    <div class="side-col">

      <div class="card">
        <div class="card-head">
          <div class="card-title"><i class="bi bi-pie-chart-fill"></i> ملخص مالي</div>
          <span class="prog-pct">{{ profitMargin }}%</span>
        </div>
        <div class="circ-wrap">
          <div class="circ-container">
            <svg class="circ-svg" viewBox="0 0 120 120">
              <defs><linearGradient id="finGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#1f9950"/><stop offset="100%" style="stop-color:#00e676"/></linearGradient></defs>
              <circle class="c-bg" cx="60" cy="60" r="50"/>
              <circle class="c-fill" cx="60" cy="60" r="50"
                [style.stroke-dasharray]="314"
                [style.stroke-dashoffset]="314-(314*(profitMargin>0?profitMargin:0)/100)"
                [class.c-fill-neg]="profit<0"/>
            </svg>
            <div class="circ-center">
              <div class="circ-pct">{{ profitMargin }}%</div>
              <div class="circ-lbl">هامش الربح</div>
            </div>
          </div>
        </div>
        <div class="summary-rows">
          <div class="sum-row"><span class="sum-lbl"><i class="bi bi-cash-stack"></i> الإيرادات</span><span class="sum-val g">{{ formatCurrency(totalRevenue) }}</span></div>
          <div class="sum-row"><span class="sum-lbl"><i class="bi bi-cash"></i> المصروفات</span><span class="sum-val r">{{ formatCurrency(totalExpenses) }}</span></div>
          <div class="sum-row border-top"><span class="sum-lbl"><i class="bi bi-bar-chart-fill"></i> صافي الربح</span><span class="sum-val" [class.g]="profit>=0" [class.r]="profit<0">{{ formatCurrency(profit) }}</span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-head"><div class="card-title"><i class="bi bi-lightning-charge-fill"></i> إجراءات سريعة</div></div>
        <div class="actions-grid">
          <button class="act-btn act-revenue" (click)="openAddModal('revenue')">
            <div class="act-icon"><i class="bi bi-cash-stack"></i></div><span>إضافة إيراد</span>
          </button>
          <button class="act-btn act-expense" (click)="openAddModal('expense')">
            <div class="act-icon"><i class="bi bi-cash"></i></div><span>تسجيل مصروف</span>
          </button>
          <button class="act-btn act-report" (click)="openReportModal()">
            <div class="act-icon"><i class="bi bi-file-earmark-arrow-down"></i></div><span>تصدير تقرير</span>
          </button>
          <button class="act-btn act-chart" (click)="openAnalyticsModal()">
            <div class="act-icon"><i class="bi bi-bar-chart-line-fill"></i></div><span>تحليل تفصيلي</span>
          </button>
        </div>
      </div>

    </div>
  </div>

</main>
<!-- ===== EXPORT REPORT MODAL ===== -->
<div class="modal-overlay" *ngIf="showReportModal" (click)="closeReportModal()">
  <div class="modal-container report-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-file-earmark-arrow-down"></i> تصدير تقرير مالي</h3>
      <button class="close-btn" (click)="closeReportModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">اختر نوع التقرير والفترة الزمنية لتصديره.</p>

      <div class="report-options">
        <div class="report-opt" [class.selected]="reportType==='summary'" (click)="reportType='summary'">
          <div class="report-opt-icon"><i class="bi bi-bar-chart-fill"></i></div>
          <div class="report-opt-info">
            <div class="report-opt-title">ملخص مالي شامل</div>
            <div class="report-opt-desc">إيرادات ومصروفات وأرباح وهامش الربح</div>
          </div>
          <div class="report-check"></div>
        </div>
        <div class="report-opt" [class.selected]="reportType==='transactions'" (click)="reportType='transactions'">
          <div class="report-opt-icon"><i class="bi bi-receipt"></i></div>
          <div class="report-opt-info">
            <div class="report-opt-title">سجل المعاملات التفصيلي</div>
            <div class="report-opt-desc">جميع الإيرادات والمصروفات مع التفاصيل</div>
          </div>
          <div class="report-check"></div>
        </div>
        <div class="report-opt" [class.selected]="reportType==='categories'" (click)="reportType='categories'">
          <div class="report-opt-icon"><i class="bi bi-folder2-open"></i></div>
          <div class="report-opt-info">
            <div class="report-opt-title">تقرير حسب الفئات</div>
            <div class="report-opt-desc">تحليل الإنفاق والإيرادات لكل فئة</div>
          </div>
          <div class="report-check"></div>
        </div>
      </div>

      <div class="report-period-section">
        <div class="report-period-title">الفترة الزمنية</div>
        <div class="report-period-btns">
          <button class="rp-btn" [class.active]="reportPeriod==='week'"    (click)="reportPeriod='week'">أسبوع</button>
          <button class="rp-btn" [class.active]="reportPeriod==='month'"   (click)="reportPeriod='month'">شهر</button>
          <button class="rp-btn" [class.active]="reportPeriod==='quarter'" (click)="reportPeriod='quarter'">ربع سنة</button>
          <button class="rp-btn" [class.active]="reportPeriod==='year'"    (click)="reportPeriod='year'">سنة كاملة</button>
        </div>
      </div>

      <div class="report-summary">
        <div class="report-summary-title"><i class="bi bi-clipboard-check"></i> ملخص البيانات المضمّنة</div>
        <div class="report-summary-row"><span>إجمالي الإيرادات</span><span>{{ formatCurrency(totalRevenue) }}</span></div>
        <div class="report-summary-row"><span>إجمالي المصروفات</span><span>{{ formatCurrency(totalExpenses) }}</span></div>
        <div class="report-summary-row"><span>صافي الربح</span><span>{{ formatCurrency(profit) }}</span></div>
        <div class="report-summary-row"><span>عدد المعاملات</span><span>{{ transactions.length }} معاملة</span></div>
      </div>
    </div>
    <div class="modal-footer modal-footer-btns">
      <button class="btn-cancel" (click)="closeReportModal()">إلغاء</button>
      <button class="btn-export" [class.spin]="isExporting" (click)="exportReport()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg>
        {{ isExporting ? 'جاري التصدير...' : 'تصدير التقرير' }}
      </button>
    </div>
  </div>
</div>

<!-- ===== ANALYTICS MODAL ===== -->
<div class="modal-overlay" *ngIf="showAnalyticsModal" (click)="closeAnalyticsModal()">
  <div class="modal-container analytics-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-bar-chart-line-fill"></i> التحليل التفصيلي</h3>
      <button class="close-btn" (click)="closeAnalyticsModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">

      <!-- KPIs -->
      <div class="analytics-kpis">
        <div class="akpi green">
          <div class="akpi-icon"><i class="bi bi-cash-stack"></i></div>
          <div class="akpi-val">{{ formatCurrency(totalRevenue) }}</div>
          <div class="akpi-lbl">إجمالي الإيرادات</div>
        </div>
        <div class="akpi red">
          <div class="akpi-icon"><i class="bi bi-cash"></i></div>
          <div class="akpi-val">{{ formatCurrency(totalExpenses) }}</div>
          <div class="akpi-lbl">إجمالي المصروفات</div>
        </div>
        <div class="akpi" [class.green]="profit>=0" [class.red]="profit<0">
          <div class="akpi-icon"><i class="bi bi-graph-up-arrow"></i></div>
          <div class="akpi-val">{{ formatCurrency(profit) }}</div>
          <div class="akpi-lbl">صافي الربح</div>
        </div>
        <div class="akpi">
          <div class="akpi-icon"><i class="bi bi-graph-down-arrow"></i></div>
          <div class="akpi-val">{{ profitMargin }}%</div>
          <div class="akpi-lbl">هامش الربح</div>
        </div>
        <div class="akpi">
          <div class="akpi-icon"><i class="bi bi-receipt"></i></div>
          <div class="akpi-val">{{ transactions.length }}</div>
          <div class="akpi-lbl">إجمالي المعاملات</div>
        </div>
        <div class="akpi">
          <div class="akpi-icon"><i class="bi bi-bar-chart-fill"></i></div>
          <div class="akpi-val">{{ getAvgTransaction() }}</div>
          <div class="akpi-lbl">متوسط المعاملة</div>
        </div>
      </div>

      <!-- توزيع المصروفات -->
      <div class="analytics-section">
        <div class="analytics-section-title"><i class="bi bi-cash"></i> توزيع المصروفات حسب الفئة</div>
        <div class="analytics-bars">
          <div class="abar-row" *ngFor="let cat of expensesByCategory">
            <div class="abar-label">{{ cat.name }}</div>
            <div class="abar-track">
              <div class="abar-fill" [class]="cat.color" [style.width.%]="cat.pct"></div>
            </div>
            <div class="abar-val">{{ formatCurrency(cat.amount) }}</div>
          </div>
        </div>
      </div>

      <!-- توزيع الإيرادات -->
      <div class="analytics-section">
        <div class="analytics-section-title"><i class="bi bi-cash-stack"></i> توزيع الإيرادات حسب الفئة</div>
        <div class="analytics-bars">
          <div class="abar-row" *ngFor="let cat of revenuesByCategory">
            <div class="abar-label">{{ cat.name }}</div>
            <div class="abar-track">
              <div class="abar-fill green" [style.width.%]="cat.pct"></div>
            </div>
            <div class="abar-val">{{ formatCurrency(cat.amount) }}</div>
          </div>
        </div>
      </div>

      <!-- التوصيات -->
      <div class="analytics-section">
        <div class="analytics-section-title"><i class="bi bi-lightbulb-fill"></i> رؤى وتوصيات</div>
        <div class="analytics-insights">
          <div class="insight-item" [class]="insights[0].type" *ngFor="let insight of insights">
            <div class="insight-icon"><i [class]="'bi ' + insight.icon"></i></div>
            <div class="insight-text" [innerHTML]="insight.text"></div>
          </div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-export" (click)="closeAnalyticsModal()">إغلاق</button>
    </div>
  </div>
</div>