<app-side-bar #sidebarRef (collapsedChange)="onSidebarToggle($event)"></app-side-bar>

<!-- ===== TOP NAV ===== -->
<nav class="top-nav" [class.sidebar-collapsed]="isSidebarCollapsed">
  <div class="nav-content">
    <div class="nav-left">
      <div>
        <div class="nav-page-title">ุงูุญุณุงุจุงุช ุงููุงููุฉ</div>
        <div class="nav-page-sub">ุชุชุจุน ุฅูุฑุงุฏุงุชู ููุตุฑููุงุชู ูุฃุฑุจุงุญู ุจุดูู ุงุญุชุฑุงูู</div>
      </div>
    </div>
    <div class="nav-right">
      <div class="period-selector desktop-only-flex">
        <button (click)="changePeriod('week')"    [class.active]="selectedPeriod === 'week'"    class="period-btn">ุฃุณุจูุน</button>
        <button (click)="changePeriod('month')"   [class.active]="selectedPeriod === 'month'"   class="period-btn">ุดูุฑ</button>
        <button (click)="changePeriod('quarter')" [class.active]="selectedPeriod === 'quarter'" class="period-btn">ุฑุจุน ุณูุฉ</button>
        <button (click)="changePeriod('year')"    [class.active]="selectedPeriod === 'year'"    class="period-btn">ุณูุฉ</button>
      </div>
      <button class="btn-add" (click)="refreshFinancialData()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
        <span class="btn-text">ุชุญุฏูุซ</span>
      </button>
      <button class="guide-btn" (click)="openGuide()">
        <svg viewBox="0 0 16 16" fill="white"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg>
        <span class="btn-text">ุฏููู ุงูุงุณุชุฎุฏุงู</span>
      </button>
      <!-- ุฒุฑ ุงููุงูุจุฑุฌุฑ โ ูุธูุฑ ููุท ุนูู ููุจุงูู/ุชุงุจูุช -->
      <button class="topnav-hamburger" (click)="openSidebar()" aria-label="ูุชุญ ุงููุงุฆูุฉ">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</nav>

<!-- ===== GUIDE MODAL ===== -->
<div class="modal-overlay" *ngIf="showGuide" (click)="closeGuide()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>๐ฐ ุฏููู ุงุณุชุฎุฏุงู ุงูุญุณุงุจุงุช ุงููุงููุฉ</h3>
      <button class="close-btn" (click)="closeGuide()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">ุตูุญุฉ ุงูุญุณุงุจุงุช ุงููุงููุฉ ุชููุญู ุฑุคูุฉ ุดุงููุฉ ุนู ุงููุถุน ุงููุงูู ููุดุฑูุนู.</p>
      <div class="guide-features">
        <div class="guide-item"><span class="guide-icon">๐</span><div><h4>ูุชุงุจุนุฉ ุงูุฅูุฑุงุฏุงุช</h4><p>ุชุชุจุน ูุตุงุฏุฑ ุฏุฎูู ุจุดูู ุชูุตููู</p></div></div>
        <div class="guide-item"><span class="guide-icon">๐ธ</span><div><h4>ุฅุฏุงุฑุฉ ุงููุตุฑููุงุช</h4><p>ุฑุงูุจ ูููุงุชู ูุตูููุง ุจุฏูุฉ</p></div></div>
        <div class="guide-item"><span class="guide-icon">๐</span><div><h4>ุชุญููู ุงูุฃุฑุจุงุญ</h4><p>ุงุญุณุจ ูุงูุด ุฑุจุญู ูุชุทูุฑู ุนุจุฑ ุงูุฒูู</p></div></div>
        <div class="guide-item"><span class="guide-icon">๐</span><div><h4>ุณุฌู ุงููุนุงููุงุช</h4><p>ุงุณุชุนุฑุถ ุฌููุน ุงูุนูููุงุช ุงููุงููุฉ ุจุงูุชูุตูู</p></div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="closeGuide()">ูููุชุ ุดูุฑุงู</button>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<main class="finance-main" [class.sidebar-collapsed]="isSidebarCollapsed">

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ุงููุงููุฉ...</p>
    </div>
  </div>

  <!-- Error -->
  <div class="error-banner" *ngIf="errorMessage">
    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg>
    {{ errorMessage }}
  </div>

  <!-- ===== WELCOME BANNER ===== -->
  <section class="welcome-section">
    <div class="welcome-content">
      <div class="welcome-text">
        <h1 class="welcome-title">ุงูุญุณุงุจุงุช ุงููุงููุฉ <span>๐ฐ</span></h1>
        <p class="welcome-sub">ุชุญูู ูู ุฃููุงูู ูุชุชุจุน ุฃุฏุงุกู ุงููุงูู ุจุงุญุชุฑุงููุฉ</p>
      </div>
      <div class="welcome-badges">
        <div class="w-badge">
          <span class="w-badge-icon">๐</span>
          <div>
            <span class="w-badge-lbl">ุตุงูู ุงูุฑุจุญ</span>
            <span class="w-badge-val">{{ formatCurrency(profit) }}</span>
          </div>
        </div>
        <div class="w-badge">
          <span class="w-badge-icon">๐</span>
          <div>
            <span class="w-badge-lbl">ูุงูุด ุงูุฑุจุญ</span>
            <span class="w-badge-val">{{ profitMargin }}%</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== METRICS GRID ===== -->
  <section class="metrics-grid">

    <div class="mc mc-revenue">
      <div class="mc-icon">๐ฐ</div>
      <div class="mc-lbl">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</div>
      <div class="mc-val">{{ cards[0]?.value || '0 ุฑ.ุณ' }}</div>
      <div class="mc-trend up" *ngIf="cards[0]?.up">โ {{ cards[0]?.percent }}</div>
      <div class="mc-trend down" *ngIf="!cards[0]?.up">โ {{ cards[0]?.percent }}</div>
      <div class="mini-prog"><div class="mini-prog-fill g" style="width:70%"></div></div>
    </div>

    <div class="mc mc-expenses">
      <div class="mc-icon">๐ธ</div>
      <div class="mc-lbl">ุฅุฌูุงูู ุงููุตุฑููุงุช</div>
      <div class="mc-val">{{ cards[1]?.value || '0 ุฑ.ุณ' }}</div>
      <div class="mc-trend down">โ {{ cards[1]?.percent }}</div>
      <div class="mini-prog"><div class="mini-prog-fill r" style="width:55%"></div></div>
    </div>

    <div class="mc mc-profit">
      <div class="mc-icon">๐</div>
      <div class="mc-lbl">ุตุงูู ุงูุฑุจุญ</div>
      <div class="mc-val" [class.negative-val]="profit < 0">{{ cards[2]?.value || '0 ุฑ.ุณ' }}</div>
      <div class="mc-trend up" *ngIf="profit >= 0">โ {{ cards[2]?.percent }}</div>
      <div class="mc-trend down" *ngIf="profit < 0">โ {{ cards[2]?.percent }}</div>
      <div class="mini-prog"><div class="mini-prog-fill" [class.g]="profit>=0" [class.r]="profit<0" style="width:60%"></div></div>
    </div>

    <div class="mc mc-margin">
      <div class="mc-icon">๐</div>
      <div class="mc-lbl">ูุงูุด ุงูุฑุจุญ</div>
      <div class="mc-val">{{ cards[3]?.value || '0%' }}</div>
      <div class="mc-sub">ูุณุจุฉ ุงูููุงุกุฉ</div>
      <div class="mini-prog"><div class="mini-prog-fill p" [style.width.%]="profitMargin > 0 ? profitMargin : 10"></div></div>
    </div>

  </section>

  <!-- ===== CHARTS ROW ===== -->
  <div class="charts-row">

    <div class="chart-card wide">
      <div class="chart-head">
        <div>
          <div class="chart-title">๐ ุงูุฅูุฑุงุฏุงุช ููุงุจู ุงููุตุฑููุงุช</div>
          <div class="chart-sub">ููุงุฑูุฉ ุดุงููุฉ ูููุชุฑุฉ ุงููุญุฏุฏุฉ</div>
        </div>
        <span class="chip chip-g" *ngIf="profit > 0">โ {{ profitMargin }}%</span>
        <span class="chip chip-r" *ngIf="profit <= 0">โ {{ profitMargin }}%</span>
      </div>
      <div style="height:240px"><canvas #revenueExpenseChart></canvas></div>
    </div>

    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-title">๐ฉ ุชูุฒูุน ุงููุตุฑููุงุช</div>
          <div class="chart-sub">ุญุณุจ ุงููุฆุฉ</div>
        </div>
      </div>
      <div style="height:240px"><canvas #expenseDistributionChart></canvas></div>
    </div>

  </div>

  <div class="chart-card full-width" style="margin-bottom:16px">
    <div class="chart-head">
      <div>
        <div class="chart-title">๐ ุงูุงุชุฌุงู ุงูุดูุฑู</div>
        <div class="chart-sub">ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ุนูู ูุฏุงุฑ ุงูุฃุดูุฑ</div>
      </div>
      <span class="chip chip-b">12 ุดูุฑ</span>
    </div>
    <div style="height:220px"><canvas #monthlyTrendChart></canvas></div>
    <div class="chart-foot">
      <div><span class="cs-lbl">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</span><span class="cs-val s">{{ formatCurrency(totalRevenue) }}</span></div>
      <div><span class="cs-lbl">ุฅุฌูุงูู ุงููุตุฑููุงุช</span><span class="cs-val d">{{ formatCurrency(totalExpenses) }}</span></div>
      <div><span class="cs-lbl">ุตุงูู ุงูุฑุจุญ</span><span class="cs-val" [class.s]="profit>=0" [class.d]="profit<0">{{ formatCurrency(profit) }}</span></div>
    </div>
  </div>

  <div class="chart-card full-width" style="margin-bottom:24px">
    <div class="chart-head">
      <div>
        <div class="chart-title">๐ ูุงูุด ุงูุฑุจุญ ุงูุดูุฑู</div>
        <div class="chart-sub">ุชุทูุฑ ูุณุจุฉ ุงูุฑุจุญูุฉ</div>
      </div>
    </div>
    <div style="height:200px"><canvas #profitMarginChart></canvas></div>
  </div>

  <!-- ===== BOTTOM GRID ===== -->
  <div class="bottom-grid">

    <div class="card transactions-card">
      <div class="card-head">
        <div class="card-title">๐ ุขุฎุฑ ุงููุนุงููุงุช</div>
        <span class="tx-count">{{ transactions.length }} ูุนุงููุฉ</span>
      </div>

      <div class="tx-list" *ngIf="transactions.length > 0; else noTx">
        <div class="tx-item" *ngFor="let tx of transactions"
          [class.tx-revenue]="tx.type === 'revenue'"
          [class.tx-expense]="tx.type === 'expense'"
          [class.tx-pending]="tx.type === 'pending'">
          <div class="tx-icon">
            <span *ngIf="tx.type === 'revenue'">๐ฐ</span>
            <span *ngIf="tx.type === 'expense'">๐ธ</span>
            <span *ngIf="tx.type === 'pending'">โณ</span>
          </div>
          <div class="tx-info">
            <div class="tx-title">{{ tx.title }}</div>
            <div class="tx-meta">
              <span class="tx-date">๐ {{ tx.date }}</span>
              <span class="tx-cat" *ngIf="tx.category">{{ tx.category }}</span>
            </div>
          </div>
          <div class="tx-amount"
            [class.amount-pos]="tx.amount > 0"
            [class.amount-neg]="tx.amount < 0">
            {{ tx.amount > 0 ? '+' : '' }}{{ tx.amount.toLocaleString('ar-SA') }} ุฑ.ุณ
          </div>
        </div>
      </div>

      <ng-template #noTx>
        <div class="empty-state">
          <div class="empty-icon">๐ญ</div>
          <p>ูุง ุชูุฌุฏ ูุนุงููุงุช ูุงููุฉ ุญุชู ุงูุขู</p>
        </div>
      </ng-template>
    </div>

    <div class="side-col">

      <div class="card">
        <div class="card-head">
          <div class="card-title">๐ ููุฎุต ูุงูู</div>
          <span class="prog-pct">{{ profitMargin }}%</span>
        </div>
        <div class="circ-wrap">
          <div class="circ-container">
            <svg class="circ-svg" viewBox="0 0 120 120">
              <defs>
                <linearGradient id="finGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#1f9950"/>
                  <stop offset="100%" style="stop-color:#00e676"/>
                </linearGradient>
              </defs>
              <circle class="c-bg" cx="60" cy="60" r="50"/>
              <circle class="c-fill" cx="60" cy="60" r="50"
                [style.stroke-dasharray]="314"
                [style.stroke-dashoffset]="314 - (314 * (profitMargin > 0 ? profitMargin : 0) / 100)"
                [class.c-fill-neg]="profit < 0"/>
            </svg>
            <div class="circ-center">
              <div class="circ-pct">{{ profitMargin }}%</div>
              <div class="circ-lbl">ูุงูุด ุงูุฑุจุญ</div>
            </div>
          </div>
        </div>
        <div class="summary-rows">
          <div class="sum-row"><span class="sum-lbl">๐ฐ ุงูุฅูุฑุงุฏุงุช</span><span class="sum-val g">{{ formatCurrency(totalRevenue) }}</span></div>
          <div class="sum-row"><span class="sum-lbl">๐ธ ุงููุตุฑููุงุช</span><span class="sum-val r">{{ formatCurrency(totalExpenses) }}</span></div>
          <div class="sum-row border-top"><span class="sum-lbl">๐ ุตุงูู ุงูุฑุจุญ</span><span class="sum-val" [class.g]="profit>=0" [class.r]="profit<0">{{ formatCurrency(profit) }}</span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-title">โก ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ</div>
        </div>
        <div class="actions-grid">
          <button class="act-btn act-revenue"><div class="act-icon">๐ฐ</div><span>ุฅุถุงูุฉ ุฅูุฑุงุฏ</span></button>
          <button class="act-btn act-expense"><div class="act-icon">๐ธ</div><span>ุชุณุฌูู ูุตุฑูู</span></button>
          <button class="act-btn act-report" (click)="refreshFinancialData()"><div class="act-icon">๐</div><span>ุชุตุฏูุฑ ุชูุฑูุฑ</span></button>
          <button class="act-btn act-chart"><div class="act-icon">๐</div><span>ุชุญููู ุชูุตููู</span></button>
        </div>
      </div>

    </div>

  </div>

</main>