<app-side-bar #sidebarRef (collapsedChange)="onSidebarToggle($event)"></app-side-bar>
<app-ai-chat></app-ai-chat>

<!-- ===== TOP NAV ===== -->
<nav class="top-nav" [class.sidebar-collapsed]="isSidebarCollapsed">
  <div class="nav-content">
    <div class="nav-left">
      <div>
        <div class="nav-page-title">التحليلات</div>
        <div class="nav-page-sub">رؤى ذكية لأداء مشروعك ومسار نموه</div>
      </div>
    </div>
    <div class="nav-right">
      <!-- Toggle التحديث التلقائي — مخفي على موبايل -->
      <label class="toggle-wrap desktop-only-flex">
        <div class="toggle-switch" [class.active]="autoRefreshEnabled" (click)="toggleAutoRefresh()">
          <div class="toggle-knob"></div>
        </div>
        <span class="toggle-lbl">تحديث تلقائي</span>
      </label>

      <!-- زر تحديث البيانات -->
      <button class="btn-refresh" (click)="refreshAnalytics()" [disabled]="isLoading">
        <i class="bi bi-arrow-repeat"></i>
        <span class="btn-text">تحديث</span>
      </button>

      <!-- زر دليل الاستخدام -->
      <button class="guide-btn" (click)="openGuide()">
        <i class="bi bi-info-circle-fill"></i>
        <span class="btn-text">دليل الاستخدام</span>
      </button>

      <!-- زر الهامبرجر — يظهر فقط على موبايل/تابلت -->
      <button class="topnav-hamburger" (click)="openSidebar()" aria-label="فتح القائمة">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>
</nav>

<!-- ===== GUIDE MODAL ===== -->
<div class="modal-overlay" *ngIf="showGuide" (click)="closeGuide()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-bar-chart-line-fill"></i> دليل استخدام التحليلات</h3>
      <button class="close-btn" (click)="closeGuide()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">لوحة التحليلات تعطيك رؤية شاملة ودقيقة عن أداء مشروعك.</p>
      <div class="guide-features">
        <div class="guide-item">
          <span class="guide-icon"><i class="bi bi-graph-up-arrow"></i></span>
          <div><h4>أداء الإيرادات</h4><p>تتبع نمو إيراداتك الفعلية والمتوقعة</p></div>
        </div>
        <div class="guide-item">
          <span class="guide-icon"><i class="bi bi-check2-all"></i></span>
          <div><h4>إنجاز المهام</h4><p>قارن المخطط بالمنجز أسبوعياً</p></div>
        </div>
        <div class="guide-item">
          <span class="guide-icon"><i class="bi bi-bar-chart-fill"></i></span>
          <div><h4>اتجاهات النمو</h4><p>رصد نمو الإيرادات والعملاء وحصة السوق</p></div>
        </div>
        <div class="guide-item">
          <span class="guide-icon"><i class="bi bi-lightbulb-fill"></i></span>
          <div><h4>رؤى ذكية</h4><p>توصيات مبنية على تحليل بياناتك الفعلية</p></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeGuide()">فهمت، شكراً</button>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<main class="analytics-main" [class.sidebar-collapsed]="isSidebarCollapsed">

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>جاري تحميل التحليلات...</p>
    </div>
  </div>

  <!-- Error Banner -->
  <div class="error-banner" *ngIf="errorMessage">
    <i class="bi bi-exclamation-triangle-fill"></i>
    {{ errorMessage }}
  </div>

  <!-- ===== WELCOME SECTION ===== -->
  <section class="welcome-section">
    <div class="welcome-content">
      <div class="welcome-text">
        <h1 class="welcome-title">التحليلات والرؤى <span><i class="bi bi-bar-chart-line-fill"></i></span></h1>
        <p class="welcome-sub">بيانات دقيقة وتوقعات ذكية لمساعدتك على اتخاذ قرارات أفضل</p>
      </div>
      <div class="welcome-badges">
        <!-- badge: معدل النمو ← يأخذ من statsCards[3].value -->
        <div class="w-badge">
          <span class="w-badge-icon"><i class="bi bi-graph-up-arrow"></i></span>
          <div>
            <span class="w-badge-lbl">معدل النمو</span>
            <span class="w-badge-val">+{{ statsCards[3]?.value || '0%' }}</span>
          </div>
        </div>
        <!-- badge: إنجاز المهام ← يأخذ من statsCards[1].value -->
        <div class="w-badge">
          <span class="w-badge-icon"><i class="bi bi-check2-all"></i></span>
          <div>
            <span class="w-badge-lbl">إنجاز المهام</span>
            <span class="w-badge-val">{{ statsCards[1]?.value || '0%' }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== METRICS GRID (4 كروت) ===== -->
  <!--
    [0] إجمالي الإيرادات   ← GET /finance/summary → totalRevenue
    [1] معدل إنجاز المهام  ← GET /tasks → (done/total * 100)
    [2] المصروفات الشهرية  ← GET /finance/summary → totalExpenses
    [3] معدل النمو          ← محسوب: (revenue-expenses)/revenue*100
  -->
  <section class="metrics-grid">
    <div class="mc" *ngFor="let card of statsCards; let i = index" [class]="'mc-' + card.color">
      <div class="mc-icon"><i [class]="card.icon"></i></div>
      <div class="mc-lbl">{{ card.title }}</div>
      <div class="mc-val"      *ngIf="!card.loading">{{ card.value }}</div>
      <div class="mc-skeleton" *ngIf="card.loading"></div>
      <div class="mc-trend up"   *ngIf="!card.loading &&  card.change.includes('+')">{{ card.change }}</div>
      <div class="mc-trend down" *ngIf="!card.loading && !card.change.includes('+')">{{ card.change }}</div>
      <div class="mini-prog">
        <div class="mini-prog-fill" [class]="'mpf-' + card.color" style="width:70%"></div>
      </div>
    </div>
  </section>

  <!-- ===== CHARTS ROW 1 ===== -->
  <div class="charts-row">

    <!-- مخطط الأداء العام (خط متعدد) -->
    <!-- endpoint: GET /api/v1/projects/:id/analytics/performance -->
    <!-- datasets: revenue (y محور ر.س) | tasks & satisfaction (y1 محور %) -->
    <div class="chart-card wide">
      <div class="chart-head">
        <div>
          <div class="chart-title"><i class="bi bi-graph-up-arrow"></i> الأداء العام</div>
          <div class="chart-sub">الإيرادات وإنجاز المهام ورضا العملاء — آخر 6 أشهر</div>
        </div>
        <span class="chip chip-g"><i class="bi bi-arrow-up"></i> 15%</span>
      </div>
      <div class="chart-wrap"><canvas #performanceChart></canvas></div>
    </div>

    <!-- مخطط إنجاز المهام (أعمدة) -->
    <!-- endpoint: GET /api/v1/projects/:id/tasks → يُجمَّع أسبوعياً بـ buildWeeklyTaskData() -->
    <!-- datasets: planned (مخطط) | completed (مكتمل) -->
    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-title"><i class="bi bi-check2-all"></i> إنجاز المهام</div>
          <div class="chart-sub">المخطط مقابل المكتمل أسبوعياً</div>
        </div>
      </div>
      <div class="chart-wrap"><canvas #taskCompletionChart></canvas></div>
    </div>

  </div><!-- end charts-row 1 -->

  <!-- ===== CHARTS ROW 2 ===== -->
  <div class="charts-row">

    <!-- مخطط توقعات الإيرادات (خط سنوي) -->
    <!-- endpoint: GET /api/v1/projects/:id/analytics/projection -->
    <!-- datasets: historical (6 أشهر فعلية) | projected (6 أشهر متوقعة — منقطة) -->
    <div class="chart-card wide">
      <div class="chart-head">
        <div>
          <div class="chart-title"><i class="bi bi-cash-stack"></i> توقعات الإيرادات</div>
          <div class="chart-sub">الفعلي مقابل المتوقع لكامل السنة</div>
        </div>
        <span class="chip chip-b">توقعات 2025</span>
      </div>
      <div class="chart-wrap"><canvas #revenueProjectionChart></canvas></div>
    </div>

    <!-- مخطط اتجاهات النمو (خط ربعي) -->
    <!-- endpoint: GET /api/v1/projects/:id/analytics/growth -->
    <!-- datasets: revenue (y) | customers (y1) | marketShare (y2 مخفي) -->
    <div class="chart-card">
      <div class="chart-head">
        <div>
          <div class="chart-title"><i class="bi bi-rocket-takeoff-fill"></i> اتجاهات النمو</div>
          <div class="chart-sub">الإيرادات والعملاء وحصة السوق</div>
        </div>
      </div>
      <div class="chart-wrap"><canvas #growthTrendChart></canvas></div>
    </div>

  </div><!-- end charts-row 2 -->

  <!-- ===== BOTTOM GRID ===== -->
  <div class="bottom-grid">

    <!-- كارد: الرؤى الذكية -->
    <!-- endpoint: GET /api/v1/projects/:id/analytics/insights (حالياً: generateInsights() محلياً) -->
    <div class="card insights-card">
      <div class="card-head">
        <div class="card-title"><i class="bi bi-lightbulb-fill"></i> رؤى ذكية وتوقعات</div>
        <span class="ai-badge">AI</span>
      </div>

      <div class="insights-list" *ngIf="insights.length > 0; else noInsights">
        <div class="insight-item" *ngFor="let insight of insights" [class]="'ins-' + insight.type">

          <!-- أيقونة نوع الرؤية (SVG — تتغير حسب insight.type) -->
          <div class="ins-icon">
            <svg *ngIf="insight.type === 'success'" viewBox="0 0 16 16" fill="currentColor">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M6.97 11.03a.75.75 0 0 0 1.08.022l3.992-4.99a.75.75 0 0 0-1.071-1.05L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06z"/>
            </svg>
            <svg *ngIf="insight.type === 'warning'" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
            </svg>
            <svg *ngIf="insight.type === 'info'" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
              <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
            </svg>
            <svg *ngIf="insight.type === 'danger'" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
              <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
            </svg>
          </div>

          <div class="ins-body">
            <div class="ins-title">{{ insight.title }}</div>
            <div class="ins-desc">{{ insight.description }}</div>
          </div>
          <div class="ins-confidence">
            <div class="conf-num">{{ insight.confidence }}%</div>
            <div class="conf-lbl">موثوقية</div>
          </div>
        </div>
      </div>

      <ng-template #noInsights>
        <div class="empty-state">
          <div class="empty-icon"><i class="bi bi-lightbulb"></i></div>
          <p>جاري تحليل البيانات...</p>
        </div>
      </ng-template>
    </div>

    <!-- عمود جانبي: ملخص المؤشرات + تصدير -->
    <div class="side-col">

      <!-- كارد: ملخص المؤشرات -->
      <!-- endpoint: GET /api/v1/projects/:id/analytics/kpis → kpiSummary -->
      <div class="card">
        <div class="card-head">
          <div class="card-title"><i class="bi bi-pie-chart-fill"></i> ملخص المؤشرات</div>
          <span class="chip chip-g">هذا الشهر</span>
        </div>
        <div class="kpi-list">
          <div class="kpi-row">
            <span class="kpi-lbl"><i class="bi bi-trophy-fill"></i> أعلى إيراد شهري</span>
            <span class="kpi-val g">{{ kpiSummary.topMonthlyRevenue }}</span>
          </div>
          <div class="kpi-row">
            <span class="kpi-lbl"><i class="bi bi-check2-all"></i> أفضل أسبوع إنجاز</span>
            <span class="kpi-val g">{{ kpiSummary.bestWeekCompletion }}</span>
          </div>
          <div class="kpi-row">
            <span class="kpi-lbl"><i class="bi bi-graph-up-arrow"></i> متوسط نمو شهري</span>
            <span class="kpi-val g">{{ kpiSummary.avgMonthlyGrowth }}</span>
          </div>
          <div class="kpi-row">
            <span class="kpi-lbl"><i class="bi bi-people-fill"></i> عدد العملاء الجدد</span>
            <span class="kpi-val b">{{ kpiSummary.newCustomers }}</span>
          </div>
          <div class="kpi-row">
            <span class="kpi-lbl"><i class="bi bi-graph-down-arrow"></i> معدل الفاقد</span>
            <span class="kpi-val r">{{ kpiSummary.churnRate }}</span>
          </div>
          <div class="kpi-row">
            <span class="kpi-lbl"><i class="bi bi-star-fill"></i> رضا العملاء</span>
            <span class="kpi-val g">{{ kpiSummary.satisfaction }}</span>
          </div>
        </div>
      </div>

      <!-- كارد: تصدير التقارير -->
      <!-- endpoint: GET /api/v1/projects/:id/analytics/export?format=pdf|excel -->
      <div class="card">
        <div class="card-head">
          <div class="card-title"><i class="bi bi-file-earmark-arrow-down"></i> تصدير التقارير</div>
        </div>
        <div class="export-grid">
          <button class="exp-btn" (click)="exportData('pdf')">
            <div class="exp-icon"><i class="bi bi-file-earmark-pdf-fill"></i></div>
            <span>تصدير PDF</span>
          </button>
          <button class="exp-btn" (click)="exportData('excel')">
            <div class="exp-icon"><i class="bi bi-file-earmark-spreadsheet-fill"></i></div>
            <span>تصدير Excel</span>
          </button>
        </div>
        <div class="auto-refresh-row">
          <span class="ar-lbl">تحديث تلقائي كل 5 دقائق</span>
          <div class="toggle-switch sm" [class.active]="autoRefreshEnabled" (click)="toggleAutoRefresh()">
            <div class="toggle-knob"></div>
          </div>
        </div>
      </div>

    </div><!-- end side-col -->

  </div><!-- end bottom-grid -->

</main>