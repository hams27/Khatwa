<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<app-side-bar #sidebarRef (collapsedChange)="onSidebarToggle($event)"></app-side-bar>
<app-ai-chat></app-ai-chat>

<!-- ===== TOP NAV ===== -->
<nav class="top-nav" [class.sidebar-collapsed]="isSidebarCollapsed">
  <div class="nav-content">
    <div class="nav-left">
      <div>
        <div class="nav-page-title">المهام والفريق</div>
        <div class="nav-page-sub">اسحب وأفلت المهام بين الأعمدة لتحديث حالتها</div>
      </div>
    </div>
    <div class="nav-right">
      <button class="btn-add" (click)="openNewTaskModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/></svg>
        <span class="btn-text">مهمة جديدة</span>
      </button>
      <button class="btn-refresh" (click)="refreshTasks()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
        <span class="btn-text">تحديث</span>
      </button>
      <button class="guide-btn" (click)="openGuide()">
        <svg viewBox="0 0 16 16" fill="white"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg>
        <span class="btn-text">دليل الاستخدام</span>
      </button>
      <!-- زر الهامبرجر — يظهر فقط على موبايل/تابلت -->
      <button class="topnav-hamburger" (click)="openSidebar()" aria-label="فتح القائمة">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</nav>

<!-- ===== GUIDE MODAL ===== -->
<div class="modal-overlay" *ngIf="showGuide" (click)="closeGuide()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-kanban"></i> دليل استخدام المهام والفريق</h3>
      <button class="close-btn" (click)="closeGuide()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="guide-intro">لوحة الكانبان تتيح لك إدارة مهام فريقك بسهولة وسرعة.</p>
      <div class="guide-features">
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-hand-index"></i></span><div><h4>السحب والإفلات</h4><p>حرّك المهام بين الأعمدة لتغيير حالتها</p></div></div>
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-people"></i></span><div><h4>إدارة الفريق</h4><p>تابع إنجاز كل عضو في فريقك</p></div></div>
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-lightning-charge"></i></span><div><h4>الأولويات</h4><p>حدد أولوية كل مهمة للتنظيم الأمثل</p></div></div>
        <div class="guide-item"><span class="guide-icon"><i class="bi bi-tags"></i></span><div><h4>الوسوم</h4><p>صنف المهام بالوسوم للبحث والتصفية السريعة</p></div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeGuide()">فهمت، شكراً</button>
    </div>
  </div>
</div>

<!-- ===== MAIN ===== -->
<main class="tasks-main" [class.sidebar-collapsed]="isSidebarCollapsed">

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>جاري تحميل المهام...</p>
    </div>
  </div>

  <!-- Messages -->
  <div class="success-banner" *ngIf="successMessage">
    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M6.97 11.03a.75.75 0 0 0 1.08.022l3.992-4.99a.75.75 0 0 0-1.071-1.05L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06z"/></svg>
    {{ successMessage }}
  </div>
  <div class="error-banner" *ngIf="errorMessage">
    <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/></svg>
    {{ errorMessage }}
  </div>

  <!-- ===== WELCOME BANNER ===== -->
  <section class="welcome-section">
    <div class="welcome-content">
      <div class="welcome-text">
        <h1 class="welcome-title">المهام والفريق <span><i class="bi bi-kanban"></i></span></h1>
        <p class="welcome-sub">تابع تقدم مشروعك وأدر فريقك بكفاءة عالية</p>
      </div>
      <div class="welcome-badges">
        <div class="w-badge">
          <span class="w-badge-icon"><i class="bi bi-check-circle"></i></span>
          <div>
            <span class="w-badge-lbl">مهام مكتملة</span>
            <span class="w-badge-val">{{ completedCount }}</span>
          </div>
        </div>
        <div class="w-badge">
          <span class="w-badge-icon"><i class="bi bi-people"></i></span>
          <div>
            <span class="w-badge-lbl">أعضاء الفريق</span>
            <span class="w-badge-val">{{ teamMembers.length }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== METRICS ===== -->
  <section class="metrics-grid">
    <div class="mc">
      <div class="mc-icon"><i class="bi bi-clipboard"></i></div>
      <div class="mc-lbl">قائمة المهام</div>
      <div class="mc-val">{{ todoCount }}</div>
      <div class="mini-prog"><div class="mini-prog-fill b" [style.width.%]="(todoCount / (todoCount+inProgressCount+reviewCount+completedCount||1))*100"></div></div>
    </div>
    <div class="mc">
      <div class="mc-icon"><i class="bi bi-arrow-repeat"></i></div>
      <div class="mc-lbl">قيد التنفيذ</div>
      <div class="mc-val">{{ inProgressCount }}</div>
      <div class="mini-prog"><div class="mini-prog-fill o" [style.width.%]="(inProgressCount / (todoCount+inProgressCount+reviewCount+completedCount||1))*100"></div></div>
    </div>
    <div class="mc">
      <div class="mc-icon"><i class="bi bi-eye"></i></div>
      <div class="mc-lbl">المراجعة</div>
      <div class="mc-val">{{ reviewCount }}</div>
      <div class="mini-prog"><div class="mini-prog-fill p" [style.width.%]="(reviewCount / (todoCount+inProgressCount+reviewCount+completedCount||1))*100"></div></div>
    </div>
    <div class="mc">
      <div class="mc-icon"><i class="bi bi-check2-all"></i></div>
      <div class="mc-lbl">مكتملة</div>
      <div class="mc-val">{{ completedCount }}</div>
      <div class="mc-trend up">↑ {{ ((completedCount/(todoCount+inProgressCount+reviewCount+completedCount||1))*100).toFixed(0) }}%</div>
      <div class="mini-prog"><div class="mini-prog-fill g" [style.width.%]="(completedCount / (todoCount+inProgressCount+reviewCount+completedCount||1))*100"></div></div>
    </div>
  </section>

  <!-- ===== TEAM SECTION ===== -->
  <section class="team-section">
    <div class="section-head">
      <div class="section-title"><i class="bi bi-people"></i> أعضاء الفريق</div>
      <button class="see-all" (click)="openTeamModal()">إدارة الفريق ›</button>
    </div>
    <div class="team-grid">
      <div class="member-card" *ngFor="let member of teamMembers">
        <div class="member-avatar">{{ member.avatar }}</div>
        <div class="member-info">
          <div class="member-name">{{ member.name }}</div>
          <div class="member-role">{{ member.role || 'عضو فريق' }}</div>
        </div>
        <div class="member-tasks-badge">
          <span class="tasks-num">{{ member.tasks }}</span>
          <span class="tasks-lbl">مهمة</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== KANBAN BOARD ===== -->
  <div class="kanban-board">

    <!-- TODO -->
    <div class="kanban-col">
      <div class="col-header todo">
        <div class="col-title">
          <span class="col-dot todo-dot"></span>
          <i class="bi bi-clipboard-check"></i> قائمة المهام
        </div>
        <span class="col-count">{{ todoCount }}</span>
      </div>
      <div class="tasks-list"
        cdkDropList #todoList="cdkDropList"
        [cdkDropListData]="todoTasks"
        [cdkDropListConnectedTo]="[inProgressList, reviewList, completedList]"
        (cdkDropListDropped)="drop($event, 'todo')">
        <div class="task-card" *ngFor="let task of todoTasks; trackBy: trackById"
          cdkDrag [cdkDragData]="task">

          <div class="task-body">
            <div class="task-title">{{ task.title }}</div>
            <p class="task-desc" *ngIf="task.description">{{ task.description }}</p>
            <div class="task-tags" *ngIf="task.tags && task.tags.length">
              <span class="tag" *ngFor="let tag of task.tags">{{ tag }}</span>
            </div>
            <div class="task-footer">
              <span class="priority-badge" [class]="'pri-'+task.priority">{{ getPriorityLabel(task.priority) }}</span>
              <div class="task-footer-right">
                <span class="assigned-avatar" *ngIf="task.user" [title]="task.user">{{ task.avatar }}</span>
                <span class="task-date" *ngIf="task.date"><i class="bi bi-clock"></i> {{ task.date }}</span>
                <button class="del-btn" (click)="deleteTask(task)" title="حذف">
                  <svg viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="empty-col" *ngIf="todoTasks.length === 0">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>
          <span>لا توجد مهام</span>
        </div>
      </div>
    </div>

    <!-- IN PROGRESS -->
    <div class="kanban-col">
      <div class="col-header in-progress">
        <div class="col-title">
          <span class="col-dot inprog-dot"></span>
          <i class="bi bi-arrow-repeat"></i> قيد التنفيذ
        </div>
        <span class="col-count">{{ inProgressCount }}</span>
      </div>
      <div class="tasks-list"
        cdkDropList #inProgressList="cdkDropList"
        [cdkDropListData]="inProgressTasks"
        [cdkDropListConnectedTo]="[todoList, reviewList, completedList]"
        (cdkDropListDropped)="drop($event, 'in-progress')">
        <div class="task-card" *ngFor="let task of inProgressTasks; trackBy: trackById"
          cdkDrag [cdkDragData]="task">

          <div class="task-body">
            <div class="task-title">{{ task.title }}</div>
            <p class="task-desc" *ngIf="task.description">{{ task.description }}</p>
            <div class="task-tags" *ngIf="task.tags && task.tags.length">
              <span class="tag" *ngFor="let tag of task.tags">{{ tag }}</span>
            </div>
            <div class="task-footer">
              <span class="priority-badge" [class]="'pri-'+task.priority">{{ getPriorityLabel(task.priority) }}</span>
              <div class="task-footer-right">
                <span class="assigned-avatar" *ngIf="task.user" [title]="task.user">{{ task.avatar }}</span>
                <span class="task-date" *ngIf="task.date"><i class="bi bi-clock"></i> {{ task.date }}</span>
                <button class="del-btn" (click)="deleteTask(task)">
                  <svg viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="empty-col" *ngIf="inProgressTasks.length === 0">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>
          <span>لا توجد مهام</span>
        </div>
      </div>
    </div>

    <!-- REVIEW -->
    <div class="kanban-col">
      <div class="col-header review">
        <div class="col-title">
          <span class="col-dot review-dot"></span>
          <i class="bi bi-eye"></i> المراجعة
        </div>
        <span class="col-count">{{ reviewCount }}</span>
      </div>
      <div class="tasks-list"
        cdkDropList #reviewList="cdkDropList"
        [cdkDropListData]="reviewTasks"
        [cdkDropListConnectedTo]="[todoList, inProgressList, completedList]"
        (cdkDropListDropped)="drop($event, 'review')">
        <div class="task-card" *ngFor="let task of reviewTasks; trackBy: trackById"
          cdkDrag [cdkDragData]="task">

          <div class="task-body">
            <div class="task-title">{{ task.title }}</div>
            <p class="task-desc" *ngIf="task.description">{{ task.description }}</p>
            <div class="task-tags" *ngIf="task.tags && task.tags.length">
              <span class="tag" *ngFor="let tag of task.tags">{{ tag }}</span>
            </div>
            <div class="task-footer">
              <span class="priority-badge" [class]="'pri-'+task.priority">{{ getPriorityLabel(task.priority) }}</span>
              <div class="task-footer-right">
                <span class="assigned-avatar" *ngIf="task.user" [title]="task.user">{{ task.avatar }}</span>
                <span class="task-date" *ngIf="task.date"><i class="bi bi-clock"></i> {{ task.date }}</span>
                <button class="del-btn" (click)="deleteTask(task)">
                  <svg viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="empty-col" *ngIf="reviewTasks.length === 0">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>
          <span>لا توجد مهام</span>
        </div>
      </div>
    </div>

    <!-- COMPLETED -->
    <div class="kanban-col">
      <div class="col-header completed">
        <div class="col-title">
          <span class="col-dot done-dot"></span>
          <i class="bi bi-check2-all"></i> المكتملة
        </div>
        <span class="col-count done-count">{{ completedCount }}</span>
      </div>
      <div class="tasks-list"
        cdkDropList #completedList="cdkDropList"
        [cdkDropListData]="completedTasks"
        [cdkDropListConnectedTo]="[todoList, inProgressList, reviewList]"
        (cdkDropListDropped)="drop($event, 'done')">
        <div class="task-card task-done" *ngFor="let task of completedTasks; trackBy: trackById"
          cdkDrag [cdkDragData]="task">

          <div class="task-body">
            <div class="task-title done-title">{{ task.title }}</div>
            <p class="task-desc" *ngIf="task.description">{{ task.description }}</p>
            <div class="task-tags" *ngIf="task.tags && task.tags.length">
              <span class="tag" *ngFor="let tag of task.tags">{{ tag }}</span>
            </div>
            <div class="task-footer">
              <span class="priority-badge" [class]="'pri-'+task.priority">{{ getPriorityLabel(task.priority) }}</span>
              <div class="task-footer-right">
                <span class="assigned-avatar" *ngIf="task.user" [title]="task.user">{{ task.avatar }}</span>
                <span class="task-date" *ngIf="task.date"><i class="bi bi-clock"></i> {{ task.date }}</span>
                <button class="del-btn" (click)="deleteTask(task)">
                  <svg viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="empty-col" *ngIf="completedTasks.length === 0">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/></svg>
          <span>لا توجد مهام</span>
        </div>
      </div>
    </div>

  </div><!-- end kanban-board -->

</main>

<!-- ===== NEW TASK MODAL ===== -->
<div class="modal-overlay" *ngIf="showNewTaskModal" (click)="closeNewTaskModal()">
  <div class="modal-container modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="bi bi-plus-circle"></i> مهمة جديدة</h3>
      <button class="close-btn" (click)="closeNewTaskModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">عنوان المهمة *</label>
        <input type="text" [(ngModel)]="newTask.title"
          placeholder="مثال: إنشاء تصميم للحملة الإعلانية"
          class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">الوصف</label>
        <textarea [(ngModel)]="newTask.description"
          placeholder="تفاصيل إضافية عن المهمة..."
          rows="3" class="form-input"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">الحالة</label>
          <select [(ngModel)]="newTask.status" class="form-input">
            <option value="todo">قائمة المهام</option>
            <option value="in-progress">قيد التنفيذ</option>
            <option value="review">المراجعة</option>
            <option value="done">مكتملة</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">الأولوية</label>
          <select [(ngModel)]="newTask.priority" class="form-input">
            <option *ngFor="let p of priorityOptions" [value]="p.value">{{ p.label }}</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">تاريخ الاستحقاق</label>
        <input type="date" [(ngModel)]="newTask.dueDate" class="form-input">
      </div>
      <div class="form-group" *ngIf="teamMembers.length > 0">
        <label class="form-label">تعيين لعضو</label>
        <select [(ngModel)]="newTask.user" class="form-input">
          <option [ngValue]="undefined">— بدون تعيين —</option>
          <option *ngFor="let m of teamMembers" [value]="m.name">
            {{ m.avatar }} {{ m.name }} · {{ m.role || 'عضو' }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">الوسوم</label>
        <div class="tags-grid">
          <button type="button" *ngFor="let tag of availableTags"
            (click)="toggleTag(tag)"
            class="tag-btn" [class.tag-active]="newTask.tags?.includes(tag)">
            {{ tag }}
          </button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeNewTaskModal()">إلغاء</button>
      <button class="btn-primary" (click)="createTask()">إنشاء المهمة</button>
    </div>
  </div>
</div>

<!-- ===== TEAM MANAGEMENT MODAL ===== -->
<div class="modal-overlay" *ngIf="showTeamModal" (click)="closeTeamModal()">
  <div class="modal-container modal-team" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h3><i class="bi bi-people"></i> إدارة الفريق</h3>
      <button class="close-btn" (click)="closeTeamModal()">
        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
      </button>
    </div>

    <div class="modal-body team-modal-body">

      <!-- Add Member Form -->
      <div class="add-member-form">
        <div class="add-member-title"><i class="bi bi-person-plus"></i> إضافة عضو جديد</div>
        <div class="add-member-row">
          <div class="form-group flex-1" [class.has-error]="teamFormErrors.name">
            <input type="text" class="form-input" [(ngModel)]="newMember.name"
              placeholder="اسم العضو *" maxlength="50">
            <span class="field-error" *ngIf="teamFormErrors.name">{{ teamFormErrors.name }}</span>
          </div>
          <div class="form-group flex-1" [class.has-error]="teamFormErrors.email">
            <input type="email" class="form-input" [(ngModel)]="newMember.email"
              placeholder="البريد الإلكتروني *" maxlength="100">
            <span class="field-error" *ngIf="teamFormErrors.email">{{ teamFormErrors.email }}</span>
          </div>
        </div>
        <div class="add-member-row">
          <div class="form-group flex-1">
            <input type="text" class="form-input" [(ngModel)]="newMember.role"
              placeholder="المسمى الوظيفي (مثال: مطوّر، مصمم)" maxlength="50">
          </div>
          <div class="form-group" style="width:160px">
            <select class="form-input" [(ngModel)]="newMember.memberRole">
              <option value="member">عضو</option>
              <option value="admin">مشرف</option>
              <option value="owner">مالك</option>
            </select>
          </div>
          <button class="btn-add-member" (click)="addTeamMember()" [disabled]="isAddingMember">
            <span *ngIf="!isAddingMember">إضافة</span>
            <span *ngIf="isAddingMember">...</span>
          </button>
        </div>
      </div>

      <!-- Members List -->
      <div class="members-list-title">أعضاء الفريق الحاليين ({{ teamMembers.length }})</div>

      <div class="members-list" *ngIf="teamMembers.length > 0; else noMembers">
        <div class="member-row" *ngFor="let member of teamMembers">
          <div class="member-avatar-lg">{{ member.avatar }}</div>
          <div class="member-info-full">
            <div class="member-name-lg">
              {{ member.name }}
              <span class="role-badge" [class.role-owner]="member.memberRole==='owner'" [class.role-admin]="member.memberRole==='admin'">
                {{ member.memberRole==='owner' ? 'مالك' : member.memberRole==='admin' ? 'مشرف' : 'عضو' }}
              </span>
            </div>
            <div class="member-meta">
              <span *ngIf="member.email"><i class="bi bi-envelope"></i> {{ member.email }}</span>
              <span *ngIf="member.role">· {{ member.role }}</span>
            </div>
          </div>
          <div class="member-tasks-info">
            <span class="tasks-chip">{{ member.tasks }} مهمة</span>
          </div>
          <div class="member-actions">
            <select class="role-select" [(ngModel)]="member.memberRole"
              (change)="updateMemberRole(member)"
              [disabled]="member.memberRole==='owner'">
              <option value="member">عضو</option>
              <option value="admin">مشرف</option>
              <option value="owner">مالك</option>
            </select>
            <button class="btn-remove" (click)="removeMember(member)"
              [disabled]="member.memberRole==='owner'" title="إزالة من الفريق">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <ng-template #noMembers>
        <div class="empty-state">
          <div class="empty-icon"><i class="bi bi-people"></i></div>
          <p>لا يوجد أعضاء في الفريق حتى الآن. أضف أول عضو!</p>
        </div>
      </ng-template>

    </div>

    <div class="modal-footer" style="justify-content:flex-end">
      <button class="btn-cancel" (click)="closeTeamModal()">إغلاق</button>
    </div>

  </div>
</div>